/**
 * Copyleft 2010-2011 Jay and Han (laughinghan@gmail.com)
 *   under the GNU Lesser General Public License
 *     http://www.gnu.org/licenses/lgpl.html
 * Project Website: http://mathquill.com
 */(function(){function bb(a,b,c){m.apply(this,arguments)}function ba(b){this.parent=this.root=b;var c=this.jQ=this._jQ=a('<span class="cursor"></span>');this.blink=function(){c.toggleClass("blink")}}function _(a,b){k.call(this,a,"<big>"+b+"</big>")}function $(a,b,c){k.call(this,a,'<span class="comma">'+b+"</span>",c)}function Z(a,b){W.apply(this,arguments)}function Y(a,b,c){k.call(this,a,'<span class="binary-operator">'+b+"</span>",c)}function X(a,b){k.call(this,a,'<span class="nonSymbola">'+(b||a)+"</span>")}function W(a,b){k.call(this,a,"<span>"+(b||a)+"</span>")}function U(a,b){k.call(this,"\\"+b+" ","<span>"+b+"</span>",b)}function T(a,b){k.call(this,a,"<var>"+(b||a)+"</var>")}function S(a){this.init("\\vector",b,b,a)}function R(){Q.apply(this,arguments)}function Q(c){this.init("\\binom",b,b,c),this.jQ.wrapInner('<span class="array"></span>'),this.blockjQ=this.jQ.children(),this.bracketjQs=a('<span class="paren">(</span>').prependTo(this.jQ).add(a('<span class="paren">)</span>').appendTo(this.jQ))}function P(a){this.init("\\"),a&&(this.replacedFragment=a.detach(),this.isEmpty=function(){return!1})}function O(a,b){function d(){M.apply(this,arguments)}c=d.prototype=new M,c.cmd=a,c.html_template=[b];return d}function N(){}function M(a){a instanceof m?this.replacedText=a.remove().jQ.text():typeof a=="string"&&(this.replacedText=a),this.init()}function L(a){J.call(this,"|","|",a)}function K(a,b,c){I.call(this,a,b,a,b,c)}function J(a,b,c){H.call(this,a,b,a,b,c)}function I(a,b,c,d,e){H.apply(this,arguments)}function H(a,b,c,d,e){this.init("\\left"+c,['<span class="block"><span class="paren">'+a+'</span><span class="block"></span><span class="paren">'+b+"</span></span>"],[a,b],e),this.end="\\right"+d}function G(a){F.call(this,a),this.jQ=this.firstChild.jQ.detach().add(this.jQ)}function F(a){this.init("\\sqrt",b,b,a)}function E(){D.apply(this,arguments)}function D(c){this.init("\\frac",b,b,c),this.jQ.append('<span style="display:inline-block;width:0">&nbsp;</span>'),d&&this.jQ.change(function(){var b=a(this),c=b.children(".numerator"),d=b.children(".denominator"),e;c.css("width",null),d.css("width",null),e=Math.max(c.width(),d.width()),c.css("width",e+"px"),d.css("width",e+"px")})}function C(a,b,c,d){this.init(a,[b],[c],d)}function B(a,c,d){this.init(a,[c],b,d)}function A(a){var b=Array.prototype.slice.call(arguments,1);return z(a,function(){a.apply(this,Array.prototype.concat.apply(b,arguments))})}function z(a,b){b.prototype=a.prototype;return b}function q(){}function p(a){this.init("$"),this.firstChild.cursor=a,this.firstChild.textInput=function(b){if(this.skipTextInput)return!1;b!=="$"||a.parent!==this?a.write(b):this.isEmpty()?a.insertAfter(this.parent).backspace().insertNew(new W("\\$","$")).show():a.next?a.prev?a.write(b):a.insertBefore(this.parent):a.insertAfter(this.parent);return!1}}function o(){}function n(c,d,e,g){function y(){if(!x){var a=k.val();if(a){k.val("");for(var c=0;c<a.length;c+=1)i.parent.bubble("textInput",a.charAt(c))}else(i.selection||l!==b)&&n()}}function v(){var a=k.val();a.slice(0,1)==="$"&&a.slice(-1)==="$"?a=a.slice(1,-1):a="\\text{"+a+"}",i.writeLatex(a).show(),k.val("")}function u(){k.focus()}function s(d){o=b,i.blink=p,i.selection||(g?i.show():j.detach()),c.unbind("mousemove",q),a(document).unbind("mousemove",r).unbind("mouseup",s)}function r(a){delete a.target;return q(a)}function q(b){i.seek(a(b.target),b.pageX,b.pageY),(i.prev!==o.prev||i.parent!==o.parent)&&i.selectFrom(o);return!1}function n(){l=b;var a=i.selection?"$"+i.selection.latex()+"$":"";k.val(a);if(a)if(k[0].select)k[0].select();else if(document.selection){var c=k[0].createTextRange();c.expand("textedit"),c.select()}}var h=c.contents().detach();e||c.addClass("mathquill-rendered-math"),d.jQ=c.data(f,{block:d,revert:function(){c.empty().unbind(".mathquill").removeClass("mathquill-rendered-math mathquill-editable mathquill-textbox").append(h)}});var i=d.cursor=new ba(d);d.renderLatex(h.text());var j=d.textarea=a('<span class="textarea"><textarea></textarea></span>'),k=j.children(),l;d.selectionChanged=function(){l===b&&(l=setTimeout(n))},c.bind("selectstart.mathquill",function(a){a.target!==k[0]&&a.preventDefault(),a.stopPropagation()});var o,p=i.blink;c.bind("mousedown.mathquill",function(b){i.blink=a.noop,i.seek(a(b.target),b.pageX,b.pageY),o=new m(i.parent,i.prev,i.next),g||c.prepend(j),c.mousemove(q),a(document).mousemove(r).mouseup(s),b.stopPropagation()});if(!g){c.bind("cut paste",!1).bind("copy",n).prepend('<span class="selectable">$'+d.latex()+"$</span>"),k.blur(function(){i.clearSelection(),setTimeout(t)});function t(){j.detach()}}else{c.prepend(j),c.addClass("mathquill-editable"),e&&c.addClass("mathquill-textbox"),k.focus(function(a){i.parent||i.appendTo(d),i.parent.jQ.addClass("hasCursor"),i.selection?(i.selection.jQ.removeClass("blur"),setTimeout(d.selectionChanged)):i.show(),a.stopPropagation()}).blur(function(a){i.hide().parent.blur(),i.selection&&i.selection.jQ.addClass("blur"),a.stopPropagation()}),c.bind("focus.mathquill blur.mathquill",function(a){k.trigger(a)}).bind("mousedown.mathquill",function(){setTimeout(u)}).bind("click.mathquill",u).blur(),c.bind("cut",function(a){n(),i.selection&&setTimeout(function(){i.deleteSelection(),i.parent.bubble("redraw")}),a.stopPropagation()}).bind("copy",function(a){n(),x=!0,a.stopPropagation()}).bind("paste",function(a){x=!0,setTimeout(v),a.stopPropagation()});var w={},x=!1;c.bind("keydown.mathquill",function(a){w.evt=a,w.happened=!0,i.parent.bubble("keydown",a)}).bind("keypress.mathquill",function(a){w.happened?w.happened=!1:i.parent.bubble("keydown",w.evt),l!==b&&clearTimeout(l),(i.selection||l!==b)&&k.val(""),x=!1,setTimeout(y)})}}function m(b,c,d){if(!!arguments.length){var e=this;e.parent=b,e.prev=c||0,e.next=d||0,e.jQinit(e.fold(a(),function(a,b){return b.jQ.add(a)}))}}function l(){}function k(a,b,c){this.init(a,[b],[c||(a&&a.length>1?a.slice(1):a)])}function j(){}function i(){}var a=jQuery,b,c,d=a.browser.msie&&parseInt(a.browser.version)==7,e=a.browser.msie&&parseInt(a.browser.version)==8,f="[[mathquill internal data]]",g=Math.min,h=Math.max;c=i.prototype,c.prev=0,c.next=0,c.parent=0,c.firstChild=0,c.lastChild=0,c.eachChild=function(a){for(var b=this.firstChild;b;b=b.next)if(a.call(this,b)===!1)break;return this},c.foldChildren=function(a,b){this.eachChild(function(c){a=b.call(this,a,c)});return a},c.bubble=function(a,b){for(var c=this;c;c=c.parent)if(c[a]&&c[a](b)===!1)break;return this},c=j.prototype=new i,c.init=function(b,c,d,e){var g=this;b&&(g.cmd=b),c&&(g.html_template=c),d&&(g.text_template=d),g.jQ=a(g.html_template[0]).data(f,{cmd:g}),g.initBlocks(e)},c.initBlocks=function(b){var c=this;if(c.html_template.length===1)c.firstChild=c.lastChild=c.jQ.data(f).block=b&&b.blockify()||new l,c.firstChild.parent=c,c.firstChild.jQ=c.jQ.append(c.firstChild.jQ);else{var d,e,g=c.html_template.length;this.firstChild=d=e=b&&b.blockify()||new l,d.parent=c,d.jQ=a(c.html_template[1]).data(f,{block:d}).append(d.jQ).appendTo(c.jQ),d.blur();for(var h=2;h<g;h+=1)d=new l,d.parent=c,d.prev=e,e.next=d,e=d,d.jQ=a(c.html_template[h]).data(f,{block:d}).appendTo(c.jQ),d.blur();c.lastChild=d}},c.latex=function(){return this.foldChildren(this.cmd,function(a,b){return a+"{"+(b.latex()||" ")+"}"})},c.text_template=[""],c.text=function(){var a=0;return this.foldChildren(this.text_template[a],function(b,c){a+=1;var d=c.text();return b&&this.text_template[a]==="("&&d[0]==="("&&d.slice(-1)===")"?b+d.slice(1,-1)+this.text_template[a]:b+c.text()+(this.text_template[a]||"")})},c.insertAt=function(a){var b=this;b.parent=a.parent,b.next=a.next,b.prev=a.prev,a.prev?a.prev.next=b:a.parent.firstChild=b,a.next?a.next.prev=b:a.parent.lastChild=b,a.prev=b,b.jQ.insertBefore(a.jQ),b.respace(),b.next&&b.next.respace(),b.prev&&b.prev.respace(),b.placeCursor(a),b.bubble("redraw")},c.respace=a.noop,c.placeCursor=function(a){a.appendTo(this.foldChildren(this.firstChild,function(a,b){return a.isEmpty()?a:b}))},c.isEmpty=function(){return this.foldChildren(!0,function(a,b){return a&&b.isEmpty()})},c.remove=function(){var a=this,b=a.prev,c=a.next,d=a.parent;b?b.next=c:d.firstChild=c,c?c.prev=b:d.lastChild=b,a.jQ.remove();return a},c=k.prototype=new j,c.initBlocks=a.noop,c.latex=function(){return this.cmd},c.text=function(){return this.text_template},c.placeCursor=a.noop,c.isEmpty=function(){return!0},c=l.prototype=new i,c.latex=function(){return this.foldChildren("",function(a,b){return a+b.latex()})},c.text=function(){return this.firstChild===this.lastChild?this.firstChild.text():this.foldChildren("(",function(a,b){return a+b.text()})+")"},c.isEmpty=function(){return this.firstChild===0&&this.lastChild===0},c.focus=function(){this.jQ.addClass("hasCursor"),this.isEmpty()&&this.jQ.removeClass("empty");return this},c.blur=function(){this.jQ.removeClass("hasCursor"),this.isEmpty()&&this.jQ.addClass("empty");return this},c=m.prototype,c.remove=j.prototype.remove,c.jQinit=function(a){this.jQ=a},c.each=function(a){for(var b=this.prev.next||this.parent.firstChild;b!==this.next;b=b.next)if(a.call(this,b)===!1)break;return this},c.fold=function(a,b){this.each(function(c){a=b.call(this,a,c)});return a},c.latex=function(){return this.fold("",function(a,b){return a+b.latex()})},c.blockify=function(){var a=this,b=a.prev,c=a.next,d=a.parent,e=new l,f=e.firstChild=b.next||d.firstChild,g=e.lastChild=c.prev||d.lastChild;b?b.next=c:d.firstChild=c,c?c.prev=b:d.lastChild=b,f.prev=a.prev=0,g.next=a.next=0,a.parent=e,a.each(function(a){a.parent=e}),e.jQ=a.jQ;return e},c=o.prototype=new l,c.latex=function(){return l.prototype.latex.call(this).replace(/(\\[a-z]+) (?![a-z])/ig,"$1")},c.text=function(){return this.foldChildren("",function(a,b){return a+b.text()})},c.renderLatex=function(a){this.jQ.children().slice(1).remove(),this.firstChild=this.lastChild=0,this.cursor.appendTo(this).writeLatex(a),this.blur()},c.keydown=function(a){a.ctrlKey=a.ctrlKey||a.metaKey;switch(a.originalEvent&&a.originalEvent.keyIdentifier||a.which){case 32:case"Space":case"U+0020":return!1;case 8:case"Backspace":case"U+0008":if(a.ctrlKey)while(this.cursor.prev||this.cursor.selection)this.cursor.backspace();else this.cursor.backspace();break;case 27:case"Esc":case"U+001B":case 9:case"Tab":case"U+0009":if(a.ctrlKey)break;var b=this.cursor.parent;if(a.shiftKey){if(b===this.cursor.root)return this.skipTextInput=!0;b.prev?this.cursor.appendTo(b.prev):this.cursor.insertBefore(b.parent)}else{if(b===this.cursor.root)return this.skipTextInput=!0;b.next?this.cursor.prependTo(b.next):this.cursor.insertAfter(b.parent)}this.cursor.clearSelection();break;case 13:case"Enter":break;case 35:case"End":if(a.shiftKey)while(this.cursor.next||a.ctrlKey&&this.cursor.parent!==this)this.cursor.selectRight();else this.cursor.clearSelection().appendTo(a.ctrlKey?this:this.cursor.parent);break;case 36:case"Home":if(a.shiftKey)while(this.cursor.prev||a.ctrlKey&&this.cursor.parent!==this)this.cursor.selectLeft();else this.cursor.clearSelection().prependTo(a.ctrlKey?this:this.cursor.parent);break;case 37:case"Left":if(a.ctrlKey)break;a.shiftKey?this.cursor.selectLeft():this.cursor.moveLeft();break;case 38:case"Up":if(a.ctrlKey)break;if(a.shiftKey)if(this.cursor.prev)while(this.cursor.prev)this.cursor.selectLeft();else this.cursor.selectLeft();else this.cursor.parent.prev?this.cursor.clearSelection().appendTo(this.cursor.parent.prev):this.cursor.prev?this.cursor.clearSelection().prependTo(this.cursor.parent):this.cursor.parent!==this&&this.cursor.clearSelection().insertBefore(this.cursor.parent.parent);break;case 39:case"Right":if(a.ctrlKey)break;a.shiftKey?this.cursor.selectRight():this.cursor.moveRight();break;case 40:case"Down":if(a.ctrlKey)break;if(a.shiftKey)if(this.cursor.next)while(this.cursor.next)this.cursor.selectRight();else this.cursor.selectRight();else this.cursor.parent.next?this.cursor.clearSelection().prependTo(this.cursor.parent.next):this.cursor.next?this.cursor.clearSelection().appendTo(this.cursor.parent):this.cursor.parent!==this&&this.cursor.clearSelection().insertAfter(this.cursor.parent.parent);break;case 46:case"Del":case"U+007F":if(a.ctrlKey)while(this.cursor.next||this.cursor.selection)this.cursor.deleteForward();else this.cursor.deleteForward();break;case 65:case"A":case"U+0041":if(a.ctrlKey&&!a.shiftKey&&!a.altKey){if(this!==this.cursor.root)return;this.cursor.clearSelection().appendTo(this);while(this.cursor.prev)this.cursor.selectLeft();break};default:this.skipTextInput=!1;return!1}this.skipTextInput=!0,a.preventDefault();return!1},c.textInput=function(a){this.skipTextInput||this.cursor.write(a);return!1},c=p.prototype=new j,c.html_template=['<span class="mathquill-rendered-math"></span>'],c.initBlocks=function(){this.firstChild=this.lastChild=this.jQ.data(f).block=new o,this.firstChild.parent=this,this.firstChild.jQ=this.jQ},c.latex=function(){return"$"+this.firstChild.latex()+"$"},c=q.prototype=new l,c.renderLatex=function(a){var b=this,c=b.cursor;b.jQ.children().slice(1).remove(),b.firstChild=b.lastChild=0,c.show().appendTo(b),a=a.match(/(?:\\\$|[^$])+|\$(?:\\\$|[^$])*\$|\$(?:\\\$|[^$])*$/g)||"";for(var d=0;d<a.length;d+=1){var e=a[d];if(e[0]==="$"){e[-1+e.length]==="$"&&e[-2+e.length]!=="\\"?e=e.slice(1,-1):e=e.slice(1);var f=new p(c);c.insertNew(f),f.firstChild.renderLatex(e),c.show().insertAfter(f)}else for(var g=0;g<e.length;g+=1)this.cursor.insertNew(new W(e[g]))}},c.keydown=o.prototype.keydown,c.textInput=function(a){if(this.skipTextInput)return!1;this.cursor.deleteSelection(),a==="$"?this.cursor.insertNew(new p(this.cursor)):this.cursor.insertNew(new W(a));return!1};var r={},s={},t,u=document.createElement("div"),v=u.style,w={transform:1,WebkitTransform:1,MozTransform:1,OTransform:1,msTransform:1},x;for(var y in w)if(y in v){x=y;break}x?t=function(a,b,c){a.css(x,"scale("+b+","+c+")")}:"filter"in v?t=function(a,b,c){a.addClass("matrixed").css({fontSize:c+"em",filter:"progid:DXImageTransform.Microsoft.Matrix(M11="+b/c+",SizingMethod='auto expand')"})}:t=function(a,b,c){a.css("fontSize",c+"em")},z(j,B),s.mathrm=A(B,"\\mathrm",'<span class="roman font"></span>'),s.mathit=A(B,"\\mathit",'<i class="font"></i>'),s.mathbf=A(B,"\\mathbf",'<b class="font"></b>'),s.mathsf=A(B,"\\mathsf",'<span class="sans-serif font"></span>'),s.mathtt=A(B,"\\mathtt",'<span class="monospace font"></span>'),s.underline=A(B,"\\underline",'<span class="underline"></span>'),s.overline=s.bar=A(B,"\\overline",'<span class="overline"></span>'),c=C.prototype=new j,c.latex=function(){var a=this.firstChild.latex();return a.length===1?this.cmd+a:this.cmd+"{"+(a||" ")+"}"},c.redraw=function(){this.respace(),this.next&&this.next.respace(),this.prev&&this.prev.respace()},c.respace=function(){this.prev.cmd==="\\int "||this.prev instanceof C&&this.prev.cmd!=this.cmd&&this.prev.prev&&this.prev.prev.cmd==="\\int "?this.limit||(this.limit=!0,this.jQ.addClass("limit")):this.limit&&(this.limit=!1,this.jQ.removeClass("limit"));if(this.respaced=this.prev instanceof C&&this.prev.cmd!=this.cmd&&!this.prev.respaced){var a=+this.jQ.css("fontSize").slice(0,-2),b=this.prev.jQ.outerWidth();thisWidth=this.jQ.outerWidth(),this.jQ.css({left:(this.limit&&this.cmd==="_"?-0.25:0)-b/a+"em",marginRight:.1-g(thisWidth,b)/a+"em"})}else this.limit&&this.cmd==="_"?this.jQ.css({left:"-.25em",marginRight:""}):this.jQ.css({left:"",marginRight:""});return this},s.subscript=s._=z(C,function(a){C.call(this,"_","<sub></sub>","_",a)}),s.superscript=s.supscript=s["^"]=s["`"]=z(C,function(a){C.call(this,"^","<sup></sup>","**",a)}),c=D.prototype=new j,c.html_template=['<span class="fraction"></span>','<span class="numerator"></span>','<span class="denominator"></span>'],c.text_template=["(","/",")"],s.frac=s.dfrac=s.cfrac=s.fraction=D,c=E.prototype=new D,c.placeCursor=function(a){if(this.firstChild.isEmpty()){var b=this.prev;while(b&&!(b instanceof Y||b instanceof M||b instanceof _||b.cmd===","))b=b.prev;b instanceof _&&b.next instanceof C&&(b=b.next,b.next instanceof C&&b.next.cmd!=b.cmd&&(b=b.next));if(b!==this.prev){var c=(new m(this.parent,b,this)).blockify();c.jQ=this.firstChild.jQ.empty().removeClass("empty").append(c.jQ).data(f,{block:c}),c.next=this.lastChild,c.parent=this,this.firstChild=this.lastChild.prev=c}}a.appendTo(this.lastChild)},s.over=r["/"]=E,c=F.prototype=new j,c.html_template=['<span class="block"><span class="sqrt-prefix">&radic;</span></span>','<span class="sqrt-stem"></span>'],c.text_template=["sqrt(",")"],c.redraw=function(){var a=this.lastChild.jQ;t(a.prev(),1,a.innerHeight()/+a.css("fontSize").slice(0,-2)-.1)},s.sqrt=s["√"]=s["~"]=F,F.with_optional_block=G,c=G.prototype=new F,c.html_template=['<span class="block"><span class="sqrt-prefix">&radic;</span></span>','<sup class="nthroot"></sup>','<span class="sqrt-stem"></span>'],c.text_template=["sqrt[","](",")"],c.latex=function(){return"\\sqrt["+this.firstChild.latex()+"]{"+this.lastChild.latex()+"}"},s.nthroot=G,c=H.prototype=new j,c.initBlocks=function(a){this.firstChild=this.lastChild=a&&a.blockify()||new l,this.firstChild.parent=this,this.firstChild.jQ=this.jQ.children(":eq(1)").data(f,{block:this.firstChild}).append(this.firstChild.jQ);var b=this.blockjQ=this.firstChild.jQ;this.bracketjQs=b.prev().add(b.next())},c.latex=function(){return this.cmd+this.firstChild.latex()+this.end},c.redraw=function(){var a=this.blockjQ.outerHeight()/+this.blockjQ.css("fontSize").slice(0,-2);t(this.bracketjQs,g(1+.2*(a-1),1.2),1.05*a)},s.lbrace=r["{"]=z(H,function(a){H.call(this,"{","}","\\{","\\}",a)}),s.langle=s.lang=z(H,function(a){H.call(this,"&lang;","&rang;","\\langle ","\\rangle ",a)}),c=I.prototype=new H,c.placeCursor=function(a){!this.next&&this.parent.parent&&this.parent.parent.end===this.end&&this.firstChild.isEmpty()?a.backspace().insertAfter(this.parent.parent):this.firstChild.blur()},s.rbrace=r["}"]=z(I,function(a){I.call(this,"{","}","\\{","\\}",a)}),s.rangle=s.rang=z(I,function(a){I.call(this,"&lang;","&rang;","\\langle ","\\rangle ",a)}),J.prototype=H.prototype,s.lparen=r["("]=z(J,function(a){J.call(this,"(",")",a)}),s.lbrack=s.lbracket=r["["]=z(J,function(a){J.call(this,"[","]",a)}),K.prototype=I.prototype,s.rparen=r[")"]=z(K,function(a){K.call(this,"(",")",a)}),s.rbrack=s.rbracket=r["]"]=z(K,function(a){K.call(this,"[","]",a)}),c=L.prototype=new J,c.placeCursor=function(a){!this.next&&this.parent.parent&&this.parent.parent.end===this.end&&this.firstChild.isEmpty()?a.backspace().insertAfter(this.parent.parent):a.appendTo(this.firstChild)},s.lpipe=s.rpipe=r["|"]=L,c=M.prototype=new j,c.cmd="\\text",c.html_template=['<span class="text"></span>'],c.text_template=['"','"'],c.initBlocks=function(){this.firstChild=this.lastChild=this.jQ.data(f).block=new N,this.firstChild.parent=this,this.firstChild.jQ=this.jQ.append(this.firstChild.jQ)},c.placeCursor=function(a){(this.cursor=a).appendTo(this.firstChild);if(this.replacedText)for(var b=0;b<this.replacedText.length;b+=1)this.write(this.replacedText.charAt(b))},c.write=function(a){this.cursor.insertNew(new W(a))},c.keydown=function(a){if(!this.cursor.selection&&(a.which===8&&!this.cursor.prev||a.which===46&&!this.cursor.next)){this.isEmpty()&&this.cursor.insertAfter(this),a.preventDefault();return!1}},c.textInput=function(a){this.cursor.deleteSelection();if(a!=="$")this.write(a);else if(this.isEmpty())this.cursor.insertAfter(this).backspace().insertNew(new W("\\$","$"));else if(!this.cursor.next)this.cursor.insertAfter(this);else if(!this.cursor.prev)this.cursor.insertBefore(this);else{var b=new M(new m(this.firstChild,this.cursor.prev));b.placeCursor=function(a){this.prev=0,delete this.placeCursor,this.placeCursor(a)},b.firstChild.focus=function(){return this},this.cursor.insertAfter(this).insertNew(b),b.prev=this,this.cursor.insertBefore(b),delete b.firstChild.focus}return!1},c=N.prototype=new l,c.blur=function(){this.jQ.removeClass("hasCursor");if(this.isEmpty()){var a=this.parent,b=a.cursor;b.parent===this?this.jQ.addClass("empty"):(b.hide(),a.remove(),b.next===a?b.next=a.next:b.prev===a&&(b.prev=a.prev),b.show().parent.bubble("redraw"))}return this},c.focus=function(){l.prototype.focus.call(this);var a=this.parent;if(a.next.cmd===a.cmd){var b=this,c=a.cursor,d=a.next.firstChild;d.eachChild(function(a){a.parent=b,a.jQ.appendTo(b.jQ)}),this.lastChild?this.lastChild.next=d.firstChild:this.firstChild=d.firstChild,d.firstChild.prev=this.lastChild,this.lastChild=d.lastChild,d.parent.remove(),c.prev?c.insertAfter(c.prev):c.prependTo(this),c.parent.bubble("redraw")}else if(a.prev.cmd===a.cmd){var c=a.cursor;c.prev?a.prev.firstChild.focus():c.appendTo(a.prev.firstChild)}return this},r.$=s.text=s.textnormal=s.textrm=s.textup=s.textmd=M,s.em=s.italic=s.italics=s.emph=s.textit=s.textsl=O("\\textit",'<i class="text"></i>'),s.strong=s.bold=s.textbf=O("\\textbf",'<b class="text"></b>'),s.sf=s.textsf=O("\\textsf",'<span class="sans-serif text"></span>'),s.tt=s.texttt=O("\\texttt",'<span class="monospace text"></span>'),s.textsc=O("\\textsc",'<span style="font-variant:small-caps" class="text"></span>'),s.uppercase=O("\\uppercase",'<span style="text-transform:uppercase" class="text"></span>'),s.lowercase=O("\\lowercase",'<span style="text-transform:lowercase" class="text"></span>'),c=P.prototype=new j,c.html_template=['<span class="latex-command-input">\\</span>'],c.text_template=["\\"],c.placeCursor=function(b){this.cursor=b.appendTo(this.firstChild),this.replacedFragment&&(this.jQ=this.jQ.add(this.replacedFragment.jQ.addClass("blur").bind("mousedown mousemove",function(b){a(b.target=this.nextSibling).trigger(b);return!1}).insertBefore(this.jQ)))},c.latex=function(){return"\\"+this.firstChild.latex()+" "},c.keydown=function(a){if(a.which===9||a.which===13){this.renderCommand(),a.preventDefault();return!1}},c.textInput=function(a){if(a.match(/[a-z]/i)){this.cursor.deleteSelection(),this.cursor.insertNew(new W(a));return!1}this.renderCommand();if(a===" "||a==="\\"&&this.firstChild.isEmpty())return!1},c.renderCommand=function(){this.jQ=this.jQ.last(),this.remove(),this.next?this.cursor.insertBefore(this.next):this.cursor.appendTo(this.parent);var a=this.firstChild.latex(),b;if(a)if(b=s[a])b=new b(this.replacedFragment,a);else{b=new M(a),b.firstChild.focus=function(){delete this.focus;return this},this.cursor.insertNew(b).insertAfter(b),this.replacedFragment&&this.replacedFragment.remove();return}else b=new W("\\backslash ","\\");this.cursor.insertNew(b),b instanceof k&&this.replacedFragment&&this.replacedFragment.remove()},r["\\"]=P,c=Q.prototype=new j,c.html_template=['<span class="block"></span>',"<span></span>","<span></span>"],c.text_template=["choose(",",",")"],c.redraw=H.prototype.redraw,s.binom=s.binomial=Q,c=R.prototype=new Q,c.placeCursor=E.prototype.placeCursor,s.choose=R,c=S.prototype=new j,c.html_template=['<span class="array"></span>',"<span></span>"],c.latex=function(){return"\\begin{matrix}"+this.foldChildren([],function(a,b){a.push(b.latex());return a}).join("\\\\")+"\\end{matrix}"},c.text=function(){return"["+this.foldChildren([],function(a,b){a.push(b.text());return a}).join()+"]"},c.placeCursor=function(a){this.cursor=a.appendTo(this.firstChild)},c.keydown=function(b){var c=this.cursor.parent;if(c.parent===this){if(b.which===13){var d=new l;d.parent=this,d.jQ=a("<span></span>").data(f,{block:d}).insertAfter(c.jQ),c.next?c.next.prev=d:this.lastChild=d,d.next=c.next,c.next=d,d.prev=c,this.bubble("redraw").cursor.appendTo(d),b.preventDefault();return!1}if(b.which===9&&!b.shiftKey&&!c.next){if(c.isEmpty()){if(c.prev){this.cursor.insertAfter(this),delete c.prev.next,this.lastChild=c.prev,c.jQ.remove(),this.bubble("redraw"),b.preventDefault();return!1}return}var d=new l;d.parent=this,d.jQ=a("<span></span>").data(f,{block:d}).appendTo(this.jQ),this.lastChild=d,c.next=d,d.prev=c,this.bubble("redraw").cursor.appendTo(d),b.preventDefault();return!1}if(b.which===8){if(c.isEmpty()){c.prev?(this.cursor.appendTo(c.prev),c.prev.next=c.next):(this.cursor.insertBefore(this),this.firstChild=c.next),c.next?c.next.prev=c.prev:this.lastChild=c.prev,c.jQ.remove(),this.isEmpty()?this.cursor.deleteForward():this.bubble("redraw"),b.preventDefault();return!1}if(!this.cursor.prev){b.preventDefault();return!1}}}},s.vector=S,s.editable=z(p,function(){this.init("\\editable"),n(this.jQ,this.firstChild,!1,!0);var a;this.placeCursor=function(b){a=b.appendTo(this.firstChild)},this.firstChild.blur=function(){a.prev===this.parent&&(delete this.blur,this.cursor.appendTo(this),l.prototype.blur.call(this))},this.latex=function(){return"\\editable{"+this.firstChild.latex()+"}"},this.text=function(){return this.firstChild.text()}}),s.f=A(k,"f",'<var class="florin">&fnof;</var>'),c=T.prototype=new k,c.insertAt=function(a){var c=this.cmd;for(var d=0,e=a.prev;d<8&&e&&e instanceof T;d+=1,e=e.prev)c=e.cmd+c;if(e instanceof U&&V.hasOwnProperty(e.text()+c)){for(var d=0;d<c.length;d+=1)a.backspace();a.insertNew(new U(b,e.text()+c))}else{for(var d=0;d<c.length;d+=1){if(V.hasOwnProperty(c)){for(var d=1;d<c.length;d+=1)a.backspace();a.insertNew(new U(b,c));return}c=c.slice(1)}j.prototype.insertAt.apply(this,arguments)}},c.text=function(){var a=this.cmd;this.prev&&!(this.prev instanceof T)&&!(this.prev instanceof Y)&&(a="*"+a),this.next&&!(this.next instanceof Y)&&this.next.cmd!=="^"&&(a+="*");return a},c=U.prototype=new k,c.respace=function(){this.jQ[0].className=this.next instanceof C||this.next instanceof H?"":"un-italicized"};var V={ln:1,lg:1,log:1,span:1,proj:1,det:1,dim:1,min:1,max:1,mod:1,lcm:1,gcd:1,gcf:1,hcf:1,lim:1};(function(){var a={sin:1,cos:1,tan:1,sec:1,cosec:1,csc:1,cotan:1,cot:1,ctg:1};for(var b in a)V[b]=V["arc"+b]=1,s[b+"h"]=s["a"+b]=s["a"+b+"h"]=s["arc"+b+"h"]=U;for(var c in V)s[c]=U})(),W.prototype=k.prototype,r[" "]=A(W,"\\:"," "),s.prime=r["'"]=A(W,"'","&prime;"),X.prototype=k.prototype,s["@"]=X,s["&"]=A(X,"\\&","&"),s["%"]=A(X,"%","%"),s.alpha=s.beta=s.gamma=s.delta=s.zeta=s.eta=s.theta=s.iota=s.kappa=s.mu=s.nu=s.xi=s.rho=s.sigma=s.tau=s.chi=s.psi=s.omega=z(k,function(a,b){T.call(this,"\\"+b+" ","&"+b+";")}),s.phi=A(T,"\\phi ","&#981;"),s.phiv=s.varphi=A(T,"\\varphi ","&phi;"),s.epsilon=A(T,"\\epsilon ","&#1013;"),s.epsiv=s.varepsilon=A(T,"\\varepsilon ","&epsilon;"),s.piv=s.varpi=A(T,"\\varpi ","&piv;"),s.sigmaf=s.sigmav=s.varsigma=A(T,"\\varsigma ","&sigmaf;"),s.thetav=s.vartheta=s.thetasym=A(T,"\\vartheta ","&thetasym;"),s.upsilon=s.upsi=A(T,"\\upsilon ","&upsilon;"),s.gammad=s.Gammad=s.digamma=A(T,"\\digamma ","&#989;"),s.kappav=s.varkappa=A(T,"\\varkappa ","&#1008;"),s.rhov=s.varrho=A(T,"\\varrho ","&#1009;"),s.pi=s["π"]=A(X,"\\pi ","&pi;"),s.lambda=A(X,"\\lambda ","&lambda;"),s.Upsilon=s.Upsi=s.upsih=s.Upsih=A(k,"\\Upsilon ",'<var style="font-family: serif">&upsih;</var>'),s.Gamma=s.Delta=s.Theta=s.Lambda=s.Xi=s.Pi=s.Sigma=s.Phi=s.Psi=s.Omega=s.forall=z(k,function(a,b){W.call(this,"\\"+b+" ","&"+b+";")}),c=Y.prototype=new k,c.insertAt=function(a){var b=a.prev.cmd+this.cmd;b==="<="?a.backspace().insertNew(new Y("\\le ","&le;")):b===">="?a.backspace().insertNew(new Y("\\ge ","&ge;")):b==="=="?a.backspace().insertNew(new Y("\\cong ","&equiv;")):j.prototype.insertAt.apply(this,arguments)},c=Z.prototype=new Y,c.respace=function(){this.prev?this.prev instanceof Y&&this.next&&!(this.next instanceof Y)?this.jQ[0].className="unary-operator":this.jQ[0].className="binary-operator":this.jQ[0].className="";return this},s["+"]=A(Z,"+","+"),s["–"]=s["-"]=A(Z,"-","&minus;"),s["±"]=s.pm=s.plusmn=s.plusminus=A(Z,"\\pm ","&plusmn;"),s.mp=s.mnplus=s.minusplus=A(Z,"\\mp ","&#8723;"),s.sdot=s.cdot=A(Y,"\\cdot ","&middot;"),s["="]=A(Y,"=","="),s["<"]=A(Y,"<","&lt;"),s[">"]=A(Y,">","&gt;"),$.prototype=new k,s[","]=A($,",",","),s.notin=s.sim=s.oplus=s.otimes=z(Y,function(a,b){Y.call(this,"\\"+b+" ","&"+b+";")}),s.cong=A(Y,"\\cong ","&equiv;"),r["*"]=s.times=A(Y,"\\times ","&times;","[x]"),s["÷"]=s.div=s.divide=s.divides=A(Y,"\\div ","&divide;","[/]"),s["≠"]=s.ne=s.neq=A(Y,"\\ne ","&ne;"),s.ast=s.star=s.loast=s.lowast=A(Y,"\\ast ","&lowast;"),s.therefor=s.therefore=A(Y,"\\therefore ","&there4;"),s.cuz=s.because=A(Y,"\\because ","&#8757;"),s.prop=s.propto=A(Y,"\\propto ","&prop;"),s["≈"]=s.asymp=s.approx=A(Y,"\\approx ","&asymp;"),s.lt=A(Y,"<","&lt;"),s.gt=A(Y,">","&gt;"),s["≤"]=s.le=s.leq=A(Y,"\\le ","&le;"),s["≥"]=s.ge=s.geq=A(Y,"\\ge ","&ge;"),s.isin=s["in"]=A(Y,"\\in ","&isin;"),s.ni=s.contains=A(Y,"\\ni ","&ni;"),s.notni=s.niton=s.notcontains=s.doesnotcontain=A(Y,"\\not\\ni ","&#8716;"),s.sub=s.subset=A(Y,"\\subset ","&sub;"),s.sup=s.supset=s.superset=A(Y,"\\supset ","&sup;"),s.nsub=s.notsub=s.nsubset=s.notsubset=A(Y,"\\not\\subset ","&#8836;"),s.nsup=s.notsup=s.nsupset=s.notsupset=s.nsuperset=s.notsuperset=A(Y,"\\not\\supset ","&#8837;"),s.sube=s.subeq=s.subsete=s.subseteq=A(Y,"\\subseteq ","&sube;"),s.supe=s.supeq=s.supsete=s.supseteq=s.supersete=s.superseteq=A(Y,"\\supseteq ","&supe;"),s.nsube=s.nsubeq=s.notsube=s.notsubeq=s.nsubsete=s.nsubseteq=s.notsubsete=s.notsubseteq=A(Y,"\\not\\subseteq ","&#8840;"),s.nsupe=s.nsupeq=s.notsupe=s.notsupeq=s.nsupsete=s.nsupseteq=s.notsupsete=s.notsupseteq=s.nsupersete=s.nsuperseteq=s.notsupersete=s.notsuperseteq=A(Y,"\\not\\supseteq ","&#8841;"),_.prototype=new k,s["∑"]=s.sum=s.summation=A(_,"\\sum ","&sum;"),s["∏"]=s.prod=s.product=A(_,"\\prod ","&prod;"),s.coprod=s.coproduct=A(_,"\\coprod ","&#8720;"),s["∫"]=s["int"]=s.integral=A(_,"\\int ","&int;"),s.N=s.naturals=s.Naturals=A(W,"\\mathbb{N}","&#8469;"),s.P=s.primes=s.Primes=s.projective=s.Projective=s.probability=s.Probability=A(W,"\\mathbb{P}","&#8473;"),s.Z=s.integers=s.Integers=A(W,"\\mathbb{Z}","&#8484;"),s.Q=s.rationals=s.Rationals=A(W,"\\mathbb{Q}","&#8474;"),s.R=s.reals=s.Reals=A(W,"\\mathbb{R}","&#8477;"),s.C=s.complex=s.Complex=s.complexes=s.Complexes=s.complexplane=s.Complexplane=s.ComplexPlane=A(W,"\\mathbb{C}","&#8450;"),s.H=s.Hamiltonian=s.quaternions=s.Quaternions=A(W,"\\mathbb{H}","&#8461;"),s.quad=s.emsp=A(W,"\\quad ","    "),s.qquad=A(W,"\\qquad ","        "),s.diamond=A(W,"\\diamond ","&#9671;"),s.bigtriangleup=A(W,"\\bigtriangleup ","&#9651;"),s.ominus=A(W,"\\ominus ","&#8854;"),s.uplus=A(W,"\\uplus ","&#8846;"),s.bigtriangledown=A(W,"\\bigtriangledown ","&#9661;"),s.sqcap=A(W,"\\sqcap ","&#8851;"),s.triangleleft=A(W,"\\triangleleft ","&#8882;"),s.sqcup=A(W,"\\sqcup ","&#8852;"),s.triangleright=A(W,"\\triangleright ","&#8883;"),s.odot=A(W,"\\odot ","&#8857;"),s.bigcirc=A(W,"\\bigcirc ","&#9711;"),s.dagger=A(W,"\\dagger ","&#0134;"),s.ddagger=A(W,"\\ddagger ","&#135;"),s.wr=A(W,"\\wr ","&#8768;"),s.amalg=A(W,"\\amalg ","&#8720;"),s.models=A(W,"\\models ","&#8872;"),s.prec=A(W,"\\prec ","&#8826;"),s.succ=A(W,"\\succ ","&#8827;"),s.preceq=A(W,"\\preceq ","&#8828;"),s.succeq=A(W,"\\succeq ","&#8829;"),s.simeq=A(W,"\\simeq ","&#11003;"),s.mid=A(W,"\\mid ","&#8739;"),s.ll=A(W,"\\ll ","&#8810;"),s.gg=A(W,"\\gg ","&#8811;"),s.parallel=A(W,"\\parallel ","&#8741;"),s.bowtie=A(W,"\\bowtie ","&#8904;"),s.sqsubset=A(W,"\\sqsubset ","&#8847;"),s.sqsupset=A(W,"\\sqsupset ","&#8848;"),s.smile=A(W,"\\smile ","&#8995;"),s.sqsubseteq=A(W,"\\sqsubseteq ","&#8849;"),s.sqsupseteq=A(W,"\\sqsupseteq ","&#8850;"),s.doteq=A(W,"\\doteq ","&#8784;"),s.frown=A(W,"\\frown ","&#8994;"),s.vdash=A(W,"\\vdash ","&#8870;"),s.dashv=A(W,"\\dashv ","&#8867;"),s.longleftarrow=A(W,"\\longleftarrow ","&#8592;"),s.longrightarrow=A(W,"\\longrightarrow ","&#8594;"),s.Longleftarrow=A(W,"\\Longleftarrow ","&#8656;"),s.Longrightarrow=A(W,"\\Longrightarrow ","&#8658;"),s.longleftrightarrow=A(W,"\\longleftrightarrow ","&#8596;"),s.updownarrow=A(W,"\\updownarrow ","&#8597;"),s.Longleftrightarrow=A(W,"\\Longleftrightarrow ","&#8660;"),s.Updownarrow=A(W,"\\Updownarrow ","&#8661;"),s.mapsto=A(W,"\\mapsto ","&#8614;"),s.nearrow=A(W,"\\nearrow ","&#8599;"),s.hookleftarrow=A(W,"\\hookleftarrow ","&#8617;"),s.hookrightarrow=A(W,"\\hookrightarrow ","&#8618;"),s.searrow=A(W,"\\searrow ","&#8600;"),s.leftharpoonup=A(W,"\\leftharpoonup ","&#8636;"),s.rightharpoonup=A(W,"\\rightharpoonup ","&#8640;"),s.swarrow=A(W,"\\swarrow ","&#8601;"),s.leftharpoondown=A(W,"\\leftharpoondown ","&#8637;"),s.rightharpoondown=A(W,"\\rightharpoondown ","&#8641;"),s.nwarrow=A(W,"\\nwarrow ","&#8598;"),s.ldots=A(W,"\\ldots ","&#8230;"),s.cdots=A(W,"\\cdots ","&#8943;"),s.vdots=A(W,"\\vdots ","&#8942;"),s.ddots=A(W,"\\ddots ","&#8944;"),s.surd=A(W,"\\surd ","&#8730;"),s.triangle=A(W,"\\triangle ","&#9651;"),s.ell=A(W,"\\ell ","&#8467;"),s.top=A(W,"\\top ","&#8868;"),s.flat=A(W,"\\flat ","&#9837;"),s.natural=A(W,"\\natural ","&#9838;"),s.sharp=A(W,"\\sharp ","&#9839;"),s.wp=A(W,"\\wp ","&#8472;"),s.bot=A(W,"\\bot ","&#8869;"),s.clubsuit=A(W,"\\clubsuit "
,"&#9827;"),s.diamondsuit=A(W,"\\diamondsuit ","&#9826;"),s.heartsuit=A(W,"\\heartsuit ","&#9825;"),s.spadesuit=A(W,"\\spadesuit ","&#9824;"),s.oint=A(W,"\\oint ","&#8750;"),s.bigcap=A(W,"\\bigcap ","&#8745;"),s.bigcup=A(W,"\\bigcup ","&#8746;"),s.bigsqcup=A(W,"\\bigsqcup ","&#8852;"),s.bigvee=A(W,"\\bigvee ","&#8744;"),s.bigwedge=A(W,"\\bigwedge ","&#8743;"),s.bigodot=A(W,"\\bigodot ","&#8857;"),s.bigotimes=A(W,"\\bigotimes ","&#8855;"),s.bigoplus=A(W,"\\bigoplus ","&#8853;"),s.biguplus=A(W,"\\biguplus ","&#8846;"),s.lfloor=A(W,"\\lfloor ","&#8970;"),s.rfloor=A(W,"\\rfloor ","&#8971;"),s.lceil=A(W,"\\lceil ","&#8968;"),s.rceil=A(W,"\\rceil ","&#8969;"),s.slash=A(W,"\\slash ","&#47;"),s.opencurlybrace=A(W,"\\opencurlybrace ","&#123;"),s.closecurlybrace=A(W,"\\closecurlybrace ","&#125;"),s.caret=A(W,"\\caret ","^"),s.underscore=A(W,"\\underscore ","_"),s.backslash=A(W,"\\backslash ","\\"),s.vert=A(W,"|"),s.perp=s.perpendicular=A(W,"\\perp ","&perp;"),s.nabla=s.del=A(W,"\\nabla ","&nabla;"),s.hbar=A(W,"\\hbar ","&#8463;"),s.AA=s.Angstrom=s.angstrom=A(W,"\\text\\AA ","&#8491;"),s.ring=s.circ=s.circle=A(W,"\\circ ","&#8728;"),s.bull=s.bullet=A(W,"\\bullet ","&bull;"),s.setminus=s.smallsetminus=A(W,"\\setminus ","&#8726;"),s.not=s["¬"]=s.neg=A(W,"\\neg ","&not;"),s["…"]=s.dots=s.ellip=s.hellip=s.ellipsis=s.hellipsis=A(W,"\\dots ","&hellip;"),s.converges=s.darr=s.dnarr=s.dnarrow=s.downarrow=A(W,"\\downarrow ","&darr;"),s.dArr=s.dnArr=s.dnArrow=s.Downarrow=A(W,"\\Downarrow ","&dArr;"),s.diverges=s.uarr=s.uparrow=A(W,"\\uparrow ","&uarr;"),s.uArr=s.Uparrow=A(W,"\\Uparrow ","&uArr;"),s.to=A(Y,"\\to ","&rarr;"),s.rarr=s.rightarrow=A(W,"\\rightarrow ","&rarr;"),s.implies=A(Y,"\\Rightarrow ","&rArr;"),s.rArr=s.Rightarrow=A(W,"\\Rightarrow ","&rArr;"),s.gets=A(Y,"\\gets ","&larr;"),s.larr=s.leftarrow=A(W,"\\leftarrow ","&larr;"),s.impliedby=A(Y,"\\Leftarrow ","&lArr;"),s.lArr=s.Leftarrow=A(W,"\\Leftarrow ","&lArr;"),s.harr=s.lrarr=s.leftrightarrow=A(W,"\\leftrightarrow ","&harr;"),s.iff=A(Y,"\\Leftrightarrow ","&hArr;"),s.hArr=s.lrArr=s.Leftrightarrow=A(W,"\\Leftrightarrow ","&hArr;"),s.Re=s.Real=s.real=A(W,"\\Re ","&real;"),s.Im=s.imag=s.image=s.imagin=s.imaginary=s.Imaginary=A(W,"\\Im ","&image;"),s.part=s.partial=A(W,"\\partial ","&part;"),s.inf=s.infin=s.infty=s.infinity=A(W,"\\infty ","&infin;"),s.alef=s.alefsym=s.aleph=s.alephsym=A(W,"\\aleph ","&alefsym;"),s.xist=s.xists=s.exist=s.exists=A(W,"\\exists ","&exist;"),s.and=s.land=s.wedge=A(W,"\\wedge ","&and;"),s.or=s.lor=s.vee=A(W,"\\vee ","&or;"),s.o=s.O=s.empty=s.emptyset=s.oslash=s.Oslash=s.nothing=s.varnothing=A(Y,"\\varnothing ","&empty;"),s.cup=s.union=A(W,"\\cup ","&cup;"),s.cap=s.intersect=s.intersection=A(W,"\\cap ","&cap;"),s.deg=s.degree=A(W,"\\deg ","&deg;"),s.ang=s.angle=A(W,"\\angle ","&ang;"),c=ba.prototype,c.prev=0,c.next=0,c.parent=0,c.show=function(){this.jQ=this._jQ.removeClass("blink"),"intervalId"in this?clearInterval(this.intervalId):(this.next?this.selection&&this.selection.prev===this.prev?this.jQ.insertBefore(this.selection.jQ):this.jQ.insertBefore(this.next.jQ.first()):this.jQ.appendTo(this.parent.jQ),this.parent.focus()),this.intervalId=setInterval(this.blink,500);return this},c.hide=function(){"intervalId"in this&&clearInterval(this.intervalId),delete this.intervalId,this.jQ.detach(),this.jQ=a();return this},c.insertAt=function(a,b,c){var d=this.parent;this.parent=a,this.prev=b,this.next=c,d.blur()},c.insertBefore=function(a){this.insertAt(a.parent,a.prev,a),this.parent.jQ.addClass("hasCursor"),this.jQ.insertBefore(a.jQ.first());return this},c.insertAfter=function(a){this.insertAt(a.parent,a,a.next),this.parent.jQ.addClass("hasCursor"),this.jQ.insertAfter(a.jQ.last());return this},c.prependTo=function(a){this.insertAt(a,0,a.firstChild),a.textarea?this.jQ.insertAfter(a.textarea):this.jQ.prependTo(a.jQ),a.focus();return this},c.appendTo=function(a){this.insertAt(a,a.lastChild,0),this.jQ.appendTo(a.jQ),a.focus();return this},c.hopLeft=function(){this.jQ.insertBefore(this.prev.jQ.first()),this.next=this.prev,this.prev=this.prev.prev;return this},c.hopRight=function(){this.jQ.insertAfter(this.next.jQ.last()),this.prev=this.next,this.next=this.next.next;return this},c.moveLeft=function(){this.selection?this.insertBefore(this.selection.prev.next||this.parent.firstChild).clearSelection():this.prev?this.prev.lastChild?this.appendTo(this.prev.lastChild):this.hopLeft():this.parent.prev?this.appendTo(this.parent.prev):this.parent!==this.root&&this.insertBefore(this.parent.parent);return this.show()},c.moveRight=function(){this.selection?this.insertAfter(this.selection.next.prev||this.parent.lastChild).clearSelection():this.next?this.next.firstChild?this.prependTo(this.next.firstChild):this.hopRight():this.parent.next?this.prependTo(this.parent.next):this.parent!==this.root&&this.insertAfter(this.parent.parent);return this.show()},c.seek=function(a,b,c){var d=this.clearSelection();if(a.hasClass("empty")){d.prependTo(a.data(f).block);return d}var e=a.data(f);if(e){if(e.cmd&&!e.block){a.outerWidth()>2*(b-a.offset().left)?d.insertBefore(e.cmd):d.insertAfter(e.cmd);return d}}else a=a.parent(),e=a.data(f),e||(e={block:d.root});e.cmd?d.insertAfter(e.cmd):d.appendTo(e.block);var g=d.jQ.offset().left-b,h;do d.moveLeft(),h=g,g=d.jQ.offset().left-b;while(g>0&&(d.prev||d.parent!==d.root));-g>h&&d.moveRight();return d},c.writeLatex=function(a){this.deleteSelection(),a=a&&a.match(/\\text\{([^}]|\\\})*\}|\\[a-z]*|[^\s]/ig)||0,function c(d){while(a.length){var e=a.shift();if(!e||e==="}"||e==="]")return;var f;if(e.slice(0,6)==="\\text{"){f=new M(e.slice(6,-1)),d.insertNew(f).insertAfter(f);continue}if(e==="\\left"||e==="\\right"){e=a.shift(),e==="\\"&&(e=a.shift()),d.insertCh(e),f=d.prev||d.parent.parent;if(d.prev)return;a.unshift("{")}else if(/^\\[a-z]+$/i.test(e)){e=e.slice(1);var f=s[e];a[0]==="["&&f.with_optional_block&&(f=f.with_optional_block);if(f)d.insertNew(f=new f(b,e));else{f=new M(e),d.insertNew(f).insertAfter(f);continue}}else e.match(/[a-eg-zA-Z]/)?f=new T(e):(f=s[e])?f=new f:f=new W(e),d.insertNew(f);f.eachChild(function(b){d.appendTo(b);var e=a.shift();if(!e)return!1;e==="{"||e==="["?c(d):d.insertCh(e)}),d.insertAfter(f)}}(this);return this.hide()},c.write=function(a){return this.show().insertCh(a)},c.insertCh=function(a){this.selection&&(this.prev=this.selection.prev,this.next=this.selection.next);var b;a.match(/^[a-eg-zA-Z]$/)?b=new T(a):(b=r[a]||s[a])?b=new b(this.selection,a):b=new W(a),this.selection&&(b instanceof k&&this.selection.remove(),delete this.selection);return this.insertNew(b)},c.insertNew=function(a){a.insertAt(this);return this},c.unwrapGramp=function(){var a=this.parent.parent,b=a.parent,c=a.prev,d=this;a.eachChild(function(d){d.isEmpty()||(d.eachChild(function(c){c.parent=b,c.jQ.insertBefore(a.jQ.first())}),d.firstChild.prev=c,c?c.next=d.firstChild:b.firstChild=d.firstChild,c=d.lastChild)}),c.next=a.next,a.next?a.next.prev=c:b.lastChild=c;if(!this.next)if(this.prev)this.next=this.prev.next;else while(!this.next){this.parent=this.parent.next;if(this.parent)this.next=this.parent.firstChild;else{this.next=a.next,this.parent=b;break}}this.next?this.insertBefore(this.next):this.appendTo(b),a.jQ.remove(),a.prev&&a.prev.respace(),a.next&&a.next.respace()},c.backspace=function(){if(!this.deleteSelection())if(this.prev)this.prev.isEmpty()?this.prev=this.prev.remove().prev:this.selectLeft();else if(this.parent!==this.root){if(this.parent.parent.isEmpty())return this.insertAfter(this.parent.parent).backspace();this.unwrapGramp()}this.prev&&this.prev.respace(),this.next&&this.next.respace(),this.parent.bubble("redraw");return this},c.deleteForward=function(){if(!this.deleteSelection())if(this.next)this.next.isEmpty()?this.next=this.next.remove().next:this.selectRight();else if(this.parent!==this.root){if(this.parent.parent.isEmpty())return this.insertBefore(this.parent.parent).deleteForward();this.unwrapGramp()}this.prev&&this.prev.respace(),this.next&&this.next.respace(),this.parent.bubble("redraw");return this},c.selectFrom=function(a){var b=this,c=a;loopThroughAncestors:for(;;){for(var d=this;d!==b.parent.parent;d=d.parent.parent)if(d.parent===c.parent){f=d,g=c;break loopThroughAncestors}for(var e=a;e!==c.parent.parent;e=e.parent.parent)if(b.parent===e.parent){f=b,g=e;break loopThroughAncestors}b.parent.parent&&(b=b.parent.parent),c.parent.parent&&(c=c.parent.parent)}var f,g,h;if(f.next!==g){for(var i=f;i;i=i.next)if(i===g.prev){h=!0;break}h||(h=g,g=f,f=h)}this.hide().selection=new bb(f.parent,f.prev,g.next),this.insertAfter(g.next.prev||g.parent.lastChild),this.root.selectionChanged()},c.selectLeft=function(){if(this.selection)if(this.selection.prev===this.prev)this.prev?(this.hopLeft().next.jQ.prependTo(this.selection.jQ),this.selection.prev=this.prev):this.parent!==this.root&&this.insertBefore(this.parent.parent).selection.levelUp();else{this.prev.jQ.insertAfter(this.selection.jQ),this.hopLeft().selection.next=this.next;if(this.selection.prev===this.prev){this.deleteSelection();return}}else{if(this.prev)this.hopLeft();else if(this.parent!==this.root)this.insertBefore(this.parent.parent);else return;this.hide().selection=new bb(this.parent,this.prev,this.next.next)}this.root.selectionChanged()},c.selectRight=function(){if(this.selection)if(this.selection.next===this.next)this.next?(this.hopRight().prev.jQ.appendTo(this.selection.jQ),this.selection.next=this.next):this.parent!==this.root&&this.insertAfter(this.parent.parent).selection.levelUp();else{this.next.jQ.insertBefore(this.selection.jQ),this.hopRight().selection.prev=this.prev;if(this.selection.next===this.next){this.deleteSelection();return}}else{if(this.next)this.hopRight();else if(this.parent!==this.root)this.insertAfter(this.parent.parent);else return;this.hide().selection=new bb(this.parent,this.prev.prev,this.next)}this.root.selectionChanged()},c.clearSelection=function(){this.show().selection&&(this.selection.clear(),delete this.selection,this.root.selectionChanged());return this},c.deleteSelection=function(){if(!this.show().selection)return!1;this.prev=this.selection.prev,this.next=this.selection.next,this.selection.remove(),delete this.selection,this.root.selectionChanged();return!0},c=bb.prototype=new m,c.jQinit=function(a){this.jQ=a.wrapAll('<span class="selection"></span>').parent()},c.levelUp=function(){this.clear().jQinit(this.parent.parent.jQ),this.prev=this.parent.parent.prev,this.next=this.parent.parent.next,this.parent=this.parent.parent.parent;return this},c.clear=function(){this.jQ.replaceWith(this.jQ.children());return this},c.blockify=function(){this.jQ.replaceWith(this.jQ=this.jQ.children());return m.prototype.blockify.call(this)},c.detach=function(){var a=m.prototype.blockify.call(this);this.blockify=function(){this.jQ.replaceWith(a.jQ=this.jQ=this.jQ.children());return a};return this},a.fn.mathquill=function(b,c){switch(b){case"redraw":this.find(":not(:has(:first))").each(function(){var b=a(this).data(f),c=b&&(b.block||b.cmd);c&&c.bubble("redraw")});return this;case"revert":return this.each(function(){var b=a(this).data(f);b&&b.revert&&b.revert()});case"latex":if(arguments.length>1)return this.each(function(){var b=a(this).data(f);b&&b.block&&b.block.renderLatex&&b.block.renderLatex(c)});var d=this.data(f);return d&&d.block&&d.block.latex();case"text":var d=this.data(f);return d&&d.block&&d.block.text();case"html":return this.html().replace(/ ?hasCursor|hasCursor /,"").replace(/ class=(""|(?= |>))/g,"").replace(/<span class="?cursor( blink)?"?><\/span>/i,"").replace(/<span class="?textarea"?><textarea><\/textarea><\/span>/i,"");case"write":if(arguments.length>1)return this.each(function(){var b=a(this).data(f),d=b&&b.block,e=d&&d.cursor;e&&(e.writeLatex(c),d.blur())});default:var e=b==="textbox",g=e||b==="editable",h=e?q:o;return this.each(function(){n(a(this),new h,e,g)})}},a(function(){a(".mathquill-editable:not(.mathquill-rendered-math)").mathquill("editable"),a(".mathquill-textbox:not(.mathquill-rendered-math)").mathquill("textbox"),a(".mathquill-embedded-latex").mathquill()})})()