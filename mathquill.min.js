/**
 * Copyleft 2010-2011 Jay and Han (laughinghan@gmail.com)
 *   under the GNU Lesser General Public License
 *     http://www.gnu.org/licenses/lgpl.html
 * Project Website: http://mathquill.com
 */(function(){function Q(a,b){var d=i(O);c.ctrlSeq=a,c.htmlTemplate=[b];return d}function I(a){H.call(this,a)}function D(a,b){k.call(this,a,[b])}function C(a){var b=Array.prototype.slice.call(arguments,1);return B(a,function(){a.apply(this,Array.prototype.concat.apply(b,arguments))})}function B(a,b){b.prototype=a.prototype;return b}function p(c,e,f,g){function x(){if(!w){var a=k.val();if(a){k.val("");for(var c=0;c<a.length;c+=1)i.parent.bubble("textInput",a.charAt(c))}else(i.selection||l!==b)&&m()}}function u(){var a=k.val();a.slice(0,1)==="$"&&a.slice(-1)==="$"?a=a.slice(1,-1):a="\\text{"+a+"}",i.writeLatex(a).show(),k.val("")}function t(){k.focus()}function r(d){n=b,i.blink=o,i.selection||(g?i.show():j.detach()),c.unbind("mousemove",p),a(document).unbind("mousemove",q).unbind("mouseup",r)}function q(a){delete a.target;return p(a)}function p(b){i.seek(a(b.target),b.pageX,b.pageY),(i.prev!==n.prev||i.parent!==n.parent)&&i.selectFrom(n);return!1}function m(){l=b;var a=i.selection?"$"+i.selection.latex()+"$":"";k.val(a);if(a)if(k[0].select)k[0].select();else if(document.selection){var c=k[0].createTextRange();c.expand("textedit"),c.select()}}var h=c.contents().detach();f||c.addClass("mathquill-rendered-math"),e.jQ=c.data(d,{block:e,revert:function(){c.empty().unbind(".mathquill").removeClass("mathquill-rendered-math mathquill-editable mathquill-textbox").append(h)}});var i=e.cursor=new ba(e);e.renderLatex(h.text());var j=e.textarea=a('<span class="textarea"><textarea></textarea></span>'),k=j.children(),l;e.selectionChanged=function(){l===b&&(l=setTimeout(m))},c.bind("selectstart.mathquill",function(a){a.target!==k[0]&&a.preventDefault(),a.stopPropagation()});var n,o=i.blink;c.bind("mousedown.mathquill",function(b){i.blink=a.noop,i.seek(a(b.target),b.pageX,b.pageY),n={parent:i.parent,prev:i.prev,next:i.next},g||c.prepend(j),c.mousemove(p),a(document).mousemove(q).mouseup(r),b.stopPropagation()});if(!g){c.bind("cut paste",!1).bind("copy",m).prepend('<span class="selectable">$'+e.latex()+"$</span>"),k.blur(function(){i.clearSelection(),setTimeout(s)});function s(){j.detach()}}else{c.prepend(j),c.addClass("mathquill-editable"),f&&c.addClass("mathquill-textbox"),k.focus(function(a){i.parent||i.appendTo(e),i.parent.jQ.addClass("hasCursor"),i.selection?(i.selection.jQ.removeClass("blur"),setTimeout(e.selectionChanged)):i.show(),a.stopPropagation()}).blur(function(a){i.hide().parent.blur(),i.selection&&i.selection.jQ.addClass("blur"),a.stopPropagation()}),c.bind("focus.mathquill blur.mathquill",function(a){k.trigger(a)}).bind("mousedown.mathquill",function(){setTimeout(t)}).bind("click.mathquill",t).blur(),c.bind("cut",function(a){m(),i.selection&&setTimeout(function(){i.deleteSelection(),i.parent.bubble("redraw")}),a.stopPropagation()}).bind("copy",function(a){m(),w=!0,a.stopPropagation()}).bind("paste",function(a){w=!0,setTimeout(u),a.stopPropagation()});var v={},w=!1;c.bind("keydown.mathquill",function(a){v.evt=a,v.happened=!0,i.parent.bubble("keydown",a)}).bind("keypress.mathquill",function(a){v.happened?v.happened=!1:i.parent.bubble("keydown",v.evt),l!==b&&clearTimeout(l),(i.selection||l!==b)&&k.val(""),w=!1,setTimeout(x)})}}function o(){return this}function i(a){return g(new a,function(){a.apply(this,arguments)})}function h(a){return g({},a)}function g(a,b){b||(b=function(){}),c=b.prototype=a;return b}var a=jQuery,b,c,d="[[mathquill internal data]]",e=Math.min,f=Math.max,j=h();c.prev=0,c.next=0,c.parent=0,c.firstChild=0,c.lastChild=0,c.eachChild=function(a){for(var b=this.firstChild;b;b=b.next)if(a.call(this,b)===!1)break;return this},c.foldChildren=function(a,b){this.eachChild(function(c){a=b.call(this,a,c)});return a},c.bubble=function(a,b){for(var c=this;c;c=c.parent)if(c[a]&&c[a](b)===!1)break;return this};var k=g(new j,function(a,b,c){var d=this;a&&(d.ctrlSeq=a),b&&(d.htmlTemplate=b),c&&(d.textTemplate=c)});c.replaces=function(a){this.replacedFragment=a},c.isEmpty=function(){return this.foldChildren(!0,function(a,b){return a&&b.isEmpty()})},c.remove=function(){var a=this,b=a.prev,c=a.next,d=a.parent;b?b.next=c:d.firstChild=c,c?c.prev=b:d.lastChild=b,a.jQ.remove();return a},c.insertAt=function(a,b,c){var d=this;d.parent=a,d.next=c,d.prev=b,b?b.next=d:a.firstChild=d,c?c.prev=d:a.lastChild=d;return d},c.createBefore=c._createBefore=function(b){var c=this;c.jQ=a(c.htmlTemplate[0]).data(d,{cmd:c}),c.createBlocks(),b.jQ.before(c.jQ),b.prev=c.insertAt(b.parent,b.prev,b.next),c.respace(),c.next&&c.next.respace(),c.prev&&c.prev.respace(),c.placeCursor(b),c.bubble("redraw")},c.createBlocks=c._createBlocks=function(){var b=this,c=b.replacedFragment;if(b.htmlTemplate.length===1)b.firstChild=b.lastChild=b.jQ.data(d).block=c&&c.blockify()||new m,b.firstChild.parent=b,b.firstChild.jQ=b.jQ.append(b.firstChild.jQ);else{var e,f,g=b.htmlTemplate.length;this.firstChild=e=f=c&&c.blockify()||new m,e.parent=b,e.jQ=a(b.htmlTemplate[1]).data(d,{block:e}).append(e.jQ).appendTo(b.jQ),e.blur();for(var h=2;h<g;h+=1)e=new m,e.parent=b,e.prev=f,f.next=e,f=e,e.jQ=a(b.htmlTemplate[h]).data(d,{block:e}).appendTo(b.jQ),e.blur();b.lastChild=e}},c.respace=a.noop,c.placeCursor=function(a){a.appendTo(this.foldChildren(this.firstChild,function(a,b){return a.isEmpty()?a:b}))},c.latex=function(){return this.foldChildren(this.ctrlSeq,function(a,b){return a+"{"+(b.latex()||" ")+"}"})},c.textTemplate=[""],c.text=function(){var a=0;return this.foldChildren(this.textTemplate[a],function(b,c){a+=1;var d=c.text();return b&&this.textTemplate[a]==="("&&d[0]==="("&&d.slice(-1)===")"?b+d.slice(1,-1)+this.textTemplate[a]:b+c.text()+(this.textTemplate[a]||"")})};var l=g(new k,function(a,b,c){k.call(this,a,[b],c||(a&&a.length>1?a.slice(1):a))});c.replaces=function(a){a.remove()},c.createBlocks=a.noop,c.latex=function(){return this.ctrlSeq},c.text=function(){return this.textTemplate},c.placeCursor=a.noop,c.isEmpty=function(){return!0};var m=g(new j);c.latex=function(){return this.foldChildren("",function(a,b){return a+b.latex()})},c.text=function(){return this.firstChild===this.lastChild?this.firstChild.text():this.foldChildren("(",function(a,b){return a+b.text()})+")"},c.isEmpty=function(){return this.firstChild===0&&this.lastChild===0},c.focus=function(){this.jQ.addClass("hasCursor"),this.isEmpty()&&this.jQ.removeClass("empty");return this},c.blur=function(){this.jQ.removeClass("hasCursor"),this.isEmpty()&&this.jQ.addClass("empty");return this};var n=h(function(b,c){if(!!arguments.length){var d=this;d.first=b,d.last=c||b,d.jQinit(d.fold(a(),function(a,b){return b.jQ.add(a)}))}});c.jQinit=function(a){this.jQ=a},c.each=function(a){for(var b=this.first;b!==this.last.next;b=b.next)if(a.call(this,b)===!1)break;return this},c.fold=function(a,b){this.each(function(c){a=b.call(this,a,c)});return a},c.latex=function(){return this.fold("",function(a,b){return a+b.latex()})},c.remove=function(){this.jQ.remove();return this.detach()},c.detach=function(){var a=this,b=a.first.prev,c=a.last.next,d=a.last.parent;b?b.next=c:d.firstChild=c,c?c.prev=b:d.lastChild=b,a.detach=o;return a},c.blockify=function(){var a=this.detach();newBlock=new m,first=newBlock.firstChild=a.first,last=newBlock.lastChild=a.last,first.prev=0,last.next=0,a.each(function(a){a.parent=newBlock}),newBlock.jQ=a.jQ;return newBlock};var q=g(new m);c.latex=function(){return m.prototype.latex.call(this).replace(/(\\[a-z]+) (?![a-z])/ig,"$1")},c.text=function(){return this.foldChildren("",function(a,b){return a+b.text()})},c.renderLatex=function(a){this.jQ.children().slice(1).remove(),this.firstChild=this.lastChild=0,this.cursor.appendTo(this).writeLatex(a),this.blur()},c.keydown=function(a){a.ctrlKey=a.ctrlKey||a.metaKey;switch(a.originalEvent&&a.originalEvent.keyIdentifier||a.which){case 8:case"Backspace":case"U+0008":if(a.ctrlKey)while(this.cursor.prev||this.cursor.selection)this.cursor.backspace();else this.cursor.backspace();break;case 27:case"Esc":case"U+001B":case 9:case"Tab":case"U+0009":if(a.ctrlKey)break;var b=this.cursor.parent;if(a.shiftKey){if(b===this.cursor.root)return this.skipTextInput=!0;b.prev?this.cursor.appendTo(b.prev):this.cursor.insertBefore(b.parent)}else{if(b===this.cursor.root)return this.skipTextInput=!0;b.next?this.cursor.prependTo(b.next):this.cursor.insertAfter(b.parent)}this.cursor.clearSelection();break;case 13:case"Enter":break;case 35:case"End":if(a.shiftKey)while(this.cursor.next||a.ctrlKey&&this.cursor.parent!==this)this.cursor.selectRight();else this.cursor.clearSelection().appendTo(a.ctrlKey?this:this.cursor.parent);break;case 36:case"Home":if(a.shiftKey)while(this.cursor.prev||a.ctrlKey&&this.cursor.parent!==this)this.cursor.selectLeft();else this.cursor.clearSelection().prependTo(a.ctrlKey?this:this.cursor.parent);break;case 37:case"Left":if(a.ctrlKey)break;a.shiftKey?this.cursor.selectLeft():this.cursor.moveLeft();break;case 38:case"Up":if(a.ctrlKey)break;if(a.shiftKey)if(this.cursor.prev)while(this.cursor.prev)this.cursor.selectLeft();else this.cursor.selectLeft();else this.cursor.parent.prev?this.cursor.clearSelection().appendTo(this.cursor.parent.prev):this.cursor.prev?this.cursor.clearSelection().prependTo(this.cursor.parent):this.cursor.parent!==this&&this.cursor.clearSelection().insertBefore(this.cursor.parent.parent);break;case 39:case"Right":if(a.ctrlKey)break;a.shiftKey?this.cursor.selectRight():this.cursor.moveRight();break;case 40:case"Down":if(a.ctrlKey)break;if(a.shiftKey)if(this.cursor.next)while(this.cursor.next)this.cursor.selectRight();else this.cursor.selectRight();else this.cursor.parent.next?this.cursor.clearSelection().prependTo(this.cursor.parent.next):this.cursor.next?this.cursor.clearSelection().appendTo(this.cursor.parent):this.cursor.parent!==this&&this.cursor.clearSelection().insertAfter(this.cursor.parent.parent);break;case 46:case"Del":case"U+007F":if(a.ctrlKey)while(this.cursor.next||this.cursor.selection)this.cursor.deleteForward();else this.cursor.deleteForward();break;case 65:case"A":case"U+0041":if(a.ctrlKey&&!a.shiftKey&&!a.altKey){if(this!==this.cursor.root)return;this.cursor.clearSelection().appendTo(this);while(this.cursor.prev)this.cursor.selectLeft();break};default:this.skipTextInput=!1;return!1}this.skipTextInput=!0,a.preventDefault();return!1},c.textInput=function(a){this.skipTextInput||this.cursor.write(a);return!1};var r=g(new k,function(a){k.call(this,"$"),this.cursor=a});c.htmlTemplate=['<span class="mathquill-rendered-math"></span>'],c.createBlocks=function(){this.firstChild=this.lastChild=this.jQ.data(d).block=new q,this.firstChild.parent=this,this.firstChild.jQ=this.jQ;var a=this.firstChild.cursor=this.cursor;this.firstChild.textInput=function(b){if(this.skipTextInput)return!1;b!=="$"||a.parent!==this?a.write(b):this.isEmpty()?a.insertAfter(this.parent).backspace().insertNew(new W("\\$","$")).show():a.next?a.prev?a.write(b):a.insertBefore(this.parent):a.insertAfter(this.parent);return!1}},c.latex=function(){return"$"+this.firstChild.latex()+"$"};var s=g(new m);c.renderLatex=function(a){var b=this,c=b.cursor;b.jQ.children().slice(1).remove(),b.firstChild=b.lastChild=0,c.show().appendTo(b),a=a.match(/(?:\\\$|[^$])+|\$(?:\\\$|[^$])*\$|\$(?:\\\$|[^$])*$/g)||"";for(var d=0;d<a.length;d+=1){var e=a[d];if(e[0]==="$"){e[-1+e.length]==="$"&&e[-2+e.length]!=="\\"?e=e.slice(1,-1):e=e.slice(1);var f=new r(c);c.insertNew(f),f.firstChild.renderLatex(e),c.show().insertAfter(f)}else for(var g=0;g<e.length;g+=1)this.cursor.insertNew(new W(e[g]))}},c.keydown=q.prototype.keydown,c.textInput=function(a){if(this.skipTextInput)return!1;this.cursor.deleteSelection(),a==="$"?this.cursor.insertNew(new r(this.cursor)):this.cursor.insertNew(new W(a));return!1};var t={},u={},v,w=document.createElement("div"),x=w.style,y={transform:1,WebkitTransform:1,MozTransform:1,OTransform:1,msTransform:1},z;for(var A in y)if(A in x){z=A;break}z?v=function(a,b,c){a.css(z,"scale("+b+","+c+")")}:"filter"in x?v=function(a,b,c){a.css("filter","progid:DXImageTransform.Microsoft.Matrix(M11="+b+",M22="+c+",SizingMethod='auto expand')")}:v=function(a,b,c){a.css("fontSize",c+"em")},B(k,D),u.mathrm=C(D,"\\mathrm",'<span class="roman font"></span>'),u.mathit=C(D,"\\mathit",'<i class="font"></i>'),u.mathbf=C(D,"\\mathbf",'<b class="font"></b>'),u.mathsf=C(D,"\\mathsf",'<span class="sans-serif font"></span>'),u.mathtt=C(D,"\\mathtt",'<span class="monospace font"></span>'),u.underline=C(D,"\\underline",'<span class="underline"></span>'),u.overline=u.bar=C(D,"\\overline",'<span class="overline"></span>');var E=g(new k,function(a,b,c){k.call(this,a,[b],[c])});c.latex=function(){var a=this.firstChild.latex();return a.length===1?this.ctrlSeq+a:this.ctrlSeq+"{"+(a||" ")+"}"},c.redraw=function(){this.respace(),this.next&&this.next.respace(),this.prev&&this.prev.respace()},c.respace=function(){this.prev.ctrlSeq==="\\int "||this.prev instanceof E&&this.prev.ctrlSeq!=this.ctrlSeq&&this.prev.prev&&this.prev.prev.ctrlSeq==="\\int "?this.limit||(this.limit=!0,this.jQ.addClass("limit")):this.limit&&(this.limit=!1,this.jQ.removeClass("limit"));if(this.respaced=this.prev instanceof E&&this.prev.ctrlSeq!=this.ctrlSeq&&!this.prev.respaced){var a=+this.jQ.css("fontSize").slice(0,-2),b=this.prev.jQ.outerWidth();thisWidth=this.jQ.outerWidth(),this.jQ.css({left:(this.limit&&this.ctrlSeq==="_"?-0.25:0)-b/a+"em",marginRight:.1-e(thisWidth,b)/a+"em"})}else this.limit&&this.ctrlSeq==="_"?this.jQ.css({left:"-.25em",marginRight:""}):this.jQ.css({left:"",marginRight:""});return this},u.subscript=u._=B(E,function(){E.call(this,"_","<sub></sub>","_")}),u.superscript=u.supscript=u["^"]=B(E,function(){E.call(this,"^","<sup></sup>","**")});var F=g(new k);c.ctrlSeq="\\frac",c.htmlTemplate=['<span class="fraction"></span>','<span class="numerator"></span>','<span class="denominator"></span>'],c.createBlocks=function(){this._createBlocks(),this.jQ.append('<span style="display:inline-block;width:0">&nbsp;</span>')},c.textTemplate=["(","/",")"],u.frac=u.dfrac=u.cfrac=u.fraction=F;var G=i(F);c.createBefore=function(a){if(!this.replacedFragment){var b=a.prev;while(b&&!(b instanceof Y||b instanceof O||b instanceof $))b=b.prev;b instanceof $&&b.next instanceof E&&(b=b.next,b.next instanceof E&&b.next.ctrlSeq!=b.ctrlSeq&&(b=b.next)),b!==a.prev&&(this.replaces((new n(b.next||a.parent.firstChild,a.prev)).detach()),a.prev=b)}this._createBefore(a)},u.over=t["/"]=G;var H=g(new k);c.ctrlSeq="\\sqrt",c.htmlTemplate=['<span class="block"><span class="sqrt-prefix">&radic;</span></span>','<span class="sqrt-stem"></span>'],c.textTemplate=["sqrt(",")"],c.redraw=function(){var a=this.lastChild.jQ;v(a.prev(),1,a.innerHeight()/+a.css("fontSize").slice(0,-2)-.1)},u.sqrt=u["√"]=H,c=I.prototype=new H,c.createBlocks=function(){k.prototype.createBlocks.call(this),this.jQ=this.firstChild.jQ.detach().add(this.jQ)},c.htmlTemplate=['<span class="block"><span class="sqrt-prefix">&radic;</span></span>','<sup class="nthroot"></sup>','<span class="sqrt-stem"></span>'],c.textTemplate=["sqrt[","](",")"],c.latex=function(){return"\\sqrt["+this.firstChild.latex()+"]{"+this.lastChild.latex()+"}"},u.nthroot=I;var J=g(new k,function(a,b,c,d){k.call(this,"\\left"+c,['<span class="block"><span class="paren">'+a+'</span><span class="block"></span><span class="paren">'+b+"</span></span>"],[a,b]),this.end="\\right"+d});c.createBlocks=function(){this.firstChild=this.lastChild=this.replacedFragment&&this.replacedFragment.blockify()||new m,this.firstChild.parent=this,this.firstChild.jQ=this.jQ.children(":eq(1)").data(d,{block:this.firstChild}).append(this.firstChild.jQ);var a=this.blockjQ=this.firstChild.jQ;this.bracketjQs=a.prev().add(a.next())},c.latex=function(){return this.ctrlSeq+this.firstChild.latex()+this.end},c.redraw=function(){var a=this.blockjQ.outerHeight()/+this.blockjQ.css("fontSize").slice(0,-2);v(this.bracketjQs,e(1+.2*(a-1),1.2),1.05*a)},u.lbrace=t["{"]=B(J,function(){J.call(this,"{","}","\\{","\\}")}),u.langle=u.lang=B(J,function(){J.call(this,"&lang;","&rang;","\\langle ","\\rangle ")});var K=i(J);c.createBefore=function(a){!a.next&&a.parent.parent&&a.parent.parent.end===this.end&&!this.replacedFragment?a.insertAfter(a.parent.parent):this._createBefore(a)},c.placeCursor=function(a){this.firstChild.blur(),a.insertAfter(this)},u.rbrace=t["}"]=B(K,function(){K.call(this,"{","}","\\{","\\}")}),u.rangle=u.rang=B(K,function(){K.call(this,"&lang;","&rang;","\\langle ","\\rangle ")});var L=B(J,function(a,b){J.call(this,a,b,a,b)});u.lparen=t["("]=B(L,function(){L.call(this,"(",")")}),u.lbrack=u.lbracket=t["["]=B(L,function(){L.call(this,"[","]")});var M=B(K,function(a,b){J.call(this,a,b,a,b)});u.rparen=t[")"]=B(M,function(){M.call(this,"(",")")}),u.rbrack=u.rbracket=t["]"]=B(M,function(){M.call(this,"[","]")});var N=g(new L,function(){L.call(this,"|","|")});c.createBefore=K.prototype.createBefore,u.lpipe=u.rpipe=t["|"]=N;var O=g(new k);c.ctrlSeq="\\text",c.htmlTemplate=['<span class="text"></span>'],c.replaces=function(a){a instanceof n?this.replacedText=a.remove().jQ.text():typeof a=="string"&&(this.replacedText=a)},c.textTemplate=['"','"'],c.createBlocks=function(){this.firstChild=this.lastChild=this.jQ.data(d).block=new P,this.firstChild.parent=this,this.firstChild.jQ=this.jQ.append(this.firstChild.jQ)},c.createBefore=function(a){this._createBefore(this.cursor=a);if(this.replacedText)for(var b=0;b<this.replacedText.length;b+=1)this.write(this.replacedText.charAt(b))},c.write=function(a){this.cursor.insertNew(new W(a))},c.keydown=function(a){if(!this.cursor.selection&&(a.which===8&&!this.cursor.prev||a.which===46&&!this.cursor.next)){this.isEmpty()&&this.cursor.insertAfter(this),a.preventDefault();return!1}},c.textInput=function(a){this.cursor.deleteSelection();if(a!=="$")this.write(a);else if(this.isEmpty())this.cursor.insertAfter(this).backspace().insertNew(new W("\\$","$"));else if(!this.cursor.next)this.cursor.insertAfter(this);else if(!this.cursor.prev)this.cursor.insertBefore(this);else{var b=new O(new n(this.cursor.next,this.firstChild.lastChild));b.placeCursor=function(a){this.prev=0,delete this.placeCursor,this.placeCursor(a)},b.firstChild.focus=function(){return this},this.cursor.insertAfter(this).insertNew(b),b.prev=this,this.cursor.insertBefore(b),delete b.firstChild.focus}return!1};var P=g(new m);c.blur=function(){this.jQ.removeClass("hasCursor");if(this.isEmpty()){var a=this.parent,b=a.cursor;b.parent===this?this.jQ.addClass("empty"):(b.hide(),a.remove(),b.next===a?b.next=a.next:b.prev===a&&(b.prev=a.prev),b.show().parent.bubble("redraw"))}return this},c.focus=function(){m.prototype.focus.call(this);var a=this.parent;if(a.next.ctrlSeq===a.ctrlSeq){var b=this,c=a.cursor,d=a.next.firstChild;d.eachChild(function(a){a.parent=b,a.jQ.appendTo(b.jQ)}),this.lastChild?this.lastChild.next=d.firstChild:this.firstChild=d.firstChild,d.firstChild.prev=this.lastChild,this.lastChild=d.lastChild,d.parent.remove(),c.prev?c.insertAfter(c.prev):c.prependTo(this),c.parent.bubble("redraw")}else if(a.prev.ctrlSeq===a.ctrlSeq){var c=a.cursor;c.prev?a.prev.firstChild.focus():c.appendTo(a.prev.firstChild)}return this},t.$=u.text=u.textnormal=u.textrm=u.textup=u.textmd=O,u.em=u.italic=u.italics=u.emph=u.textit=u.textsl=Q("\\textit",'<i class="text"></i>'),u.strong=u.bold=u.textbf=Q("\\textbf",'<b class="text"></b>'),u.sf=u.textsf=Q("\\textsf",'<span class="sans-serif text"></span>'),u.tt=u.texttt=Q("\\texttt",'<span class="monospace text"></span>'),u.textsc=Q("\\textsc",'<span style="font-variant:small-caps" class="text"></span>'),u.uppercase=Q("\\uppercase",'<span style="text-transform:uppercase" class="text"></span>'),u.lowercase=Q("\\lowercase",'<span style="text-transform:lowercase" class="text"></span>');var R=g(new k);c.ctrlSeq="\\",c.replaces=function(a){this._replacedFragment=a.detach(),this.isEmpty=function(){return!1}},c.htmlTemplate=['<span class="latex-command-input">\\</span>'],c.textTemplate=["\\"],c.createBefore=function(b){this._createBefore(b),this.cursor=b.appendTo(this.firstChild);if(this._replacedFragment){var c=this.jQ[0];this.jQ=this._replacedFragment.jQ.addClass("blur").bind("mousedown mousemove",function(b){a(b.target=c).trigger(b);return!1}).insertBefore(this.jQ).add(this.jQ)}},c.latex=function(){return"\\"+this.firstChild.latex()+" "},c.keydown=function(a){if(a.which===9||a.which===13){this.renderCommand(),a.preventDefault();return!1}},c.textInput=function(a){if(a.match(/[a-z]/i)){this.cursor.deleteSelection(),this.cursor.insertNew(new W(a));return!1}this.renderCommand();if(a===" "||a==="\\"&&this.firstChild.isEmpty())return!1},c.renderCommand=function(){this.jQ=this.jQ.last(),this.remove(),this.next?this.cursor.insertBefore(this.next):this.cursor.appendTo(this.parent);var a=this.firstChild.latex(),b;if(a)if(b=u[a])b=new b(a);else{b=new O,b.replaces(a),b.firstChild.focus=function(){delete this.focus;return this},this.cursor.insertNew(b).insertAfter(b),this._replacedFragment&&this._replacedFragment.remove();return}else b=new W("\\backslash ","\\");this._replacedFragment&&b.replaces(this._replacedFragment),this.cursor.insertNew(b)},t["\\"]=R;var S=g(new k);c.ctrlSeq="\\binom",c.htmlTemplate=['<span class="block"></span>',"<span></span>","<span></span>"],c.createBlocks=function(){this._createBlocks(),this.jQ.wrapInner('<span class="array"></span>'),this.blockjQ=this.jQ.children(),this.bracketjQs=a('<span class="paren">(</span>').prependTo(this.jQ).add(a('<span class="paren">)</span>').appendTo(this.jQ))},c.textTemplate=["choose(",",",")"],c.redraw=J.prototype.redraw,u.binom=u.binomial=S;var T=i(S);c.createBefore=G.prototype.createBefore,u.choose=T;var U=g(new k);c.ctrlSeq="\\vector",c.htmlTemplate=['<span class="array"></span>',"<span></span>"],c.latex=function(){return"\\begin{matrix}"+this.foldChildren([],function(a,b){a.push(b.latex());return a}).join("\\\\")+"\\end{matrix}"},c.text=function(){return"["+this.foldChildren([],function(a,b){a.push(b.text());return a}).join()+"]"},c.createBefore=function(a){this._createBefore(this.cursor=a)},c.keydown=function(b){var c=this.cursor.parent;if(c.parent===this){if(b.which===13){var e=new m;e.parent=this,e.jQ=a("<span></span>").data(d,{block:e}).insertAfter(c.jQ),c.next?c.next.prev=e:this.lastChild=e,e.next=c.next,c.next=e,e.prev=c,this.bubble("redraw").cursor.appendTo(e),b.preventDefault();return!1}if(b.which===9&&!b.shiftKey&&!c.next){if(c.isEmpty()){if(c.prev){this.cursor.insertAfter(this),delete c.prev.next,this.lastChild=c.prev,c.jQ.remove(),this.bubble("redraw"),b.preventDefault();return!1}return}var e=new m;e.parent=this,e.jQ=a("<span></span>").data(d,{block:e}).appendTo(this.jQ),this.lastChild=e,c.next=e,e.prev=c,this.bubble("redraw").cursor.appendTo(e),b.preventDefault();return!1}if(b.which===8){if(c.isEmpty()){c.prev?(this.cursor.appendTo(c.prev),c.prev.next=c.next):(this.cursor.insertBefore(this),this.firstChild=c.next),c.next?c.next.prev=c.prev:this.lastChild=c.prev,c.jQ.remove(),this.isEmpty()?this.cursor.deleteForward():this.bubble("redraw"),b.preventDefault();return!1}if(!this.cursor.prev){b.preventDefault();return!1}}}},u.vector=U,u.editable=B(r,function(){k.call(this,"\\editable");var a;this.createBefore=function(b){this._createBefore(a=b)},this.createBlocks=function(){r.prototype.createBlocks.call(this),p(this.jQ,this.firstChild,!1,!0),this.firstChild.blur=function(){a.prev===this.parent&&(delete this.blur,this.cursor.appendTo(this),m.prototype.blur.call(this))},this.latex=function(){return this.firstChild.latex()},this.text=function(){return this.firstChild.text()}}}),u.f=C(l,"f",'<var class="florin">&fnof;</var>');var V=g(new l,function(a,b){l.call(this,a,"<var>"+(b||a)+"</var>")});c.text=function(){var a=this.ctrlSeq;this.prev&&!(this.prev instanceof V)&&!(this.prev instanceof Y)&&(a="*"+a),this.next&&!(this.next instanceof Y)&&this.next.ctrlSeq!=="^"&&(a+="*");return a};var W=B(l,function(a,b){l.call(this,a,"<span>"+(b||a)+"</span>")});t[" "]=C(W,"\\:"," "),u.prime=t["'"]=C(W,"'","&prime;");var X=B(l,function(a,b){l.call(this,a,'<span class="nonSymbola">'+(b||a)+"</span>")});u["@"]=X,u["&"]=C(X,"\\&","&"),u["%"]=C(X,"\\%","%"),u.alpha=u.beta=u.gamma=u.delta=u.zeta=u.eta=u.theta=u.iota=u.kappa=u.mu=u.nu=u.xi=u.rho=u.sigma=u.tau=u.chi=u.psi=u.omega=B(l,function(a){V.call(this,"\\"+a+" ","&"+a+";")}),u.phi=C(V,"\\phi ","&#981;"),u.phiv=u.varphi=C(V,"\\varphi ","&phi;"),u.epsilon=C(V,"\\epsilon ","&#1013;"),u.epsiv=u.varepsilon=C(V,"\\varepsilon ","&epsilon;"),u.piv=u.varpi=C(V,"\\varpi ","&piv;"),u.sigmaf=u.sigmav=u.varsigma=C(V,"\\varsigma ","&sigmaf;"),u.thetav=u.vartheta=u.thetasym=C(V,"\\vartheta ","&thetasym;"),u.upsilon=u.upsi=C(V,"\\upsilon ","&upsilon;"),u.gammad=u.Gammad=u.digamma=C(V,"\\digamma ","&#989;"),u.kappav=u.varkappa=C(V,"\\varkappa ","&#1008;"),u.rhov=u.varrho=C(V,"\\varrho ","&#1009;"),u.pi=u["π"]=C(X,"\\pi ","&pi;"),u.lambda=C(X,"\\lambda ","&lambda;"),u.Upsilon=u.Upsi=u.upsih=u.Upsih=C(l,"\\Upsilon ",'<var style="font-family: serif">&upsih;</var>'),u.Gamma=u.Delta=u.Theta=u.Lambda=u.Xi=u.Pi=u.Sigma=u.Phi=u.Psi=u.Omega=u.forall=B(l,function(a){W.call(this,"\\"+a+" ","&"+a+";")});var Y=g(new l,function(a,b,c){l.call(this,a,'<span class="binary-operator">'+b+"</span>",c)}),Z=g(new Y,function(){W.apply(this,arguments)});c.respace=function(){this.prev?this.prev instanceof Y&&this.next&&!(this.next instanceof Y)?this.jQ[0].className="unary-operator":this.jQ[0].className="binary-operator":this.jQ[0].className="";return this},u["+"]=C(Z,"+"),u["-"]=C(Z,"-","&minus;"),u.pm=u.plusmn=u.plusminus=C(Z,"\\pm ","&plusmn;"),u.mp=u.mnplus=u.minusplus=C(Z,"\\mp ","&#8723;"),t["*"]=u.sdot=u.cdot=C(Y,"\\cdot ","&middot;"),u["="]=C(Y,"=","="),u["<"]=C(Y,"<","&lt;"),u[">"]=C(Y,">","&gt;"),u.notin=u.sim=u.cong=u.equiv=u.oplus=u.otimes=B(Y,function(a){Y.call(this,"\\"+a+" ","&"+a+";")}),u.times=B(Y,function(a){Y.call(this,"\\times ","&times;","[x]")}),u.div=u.divide=u.divides=C(Y,"\\div ","&divide;","[/]"),u.ne=u.neq=C(Y,"\\ne ","&ne;"),u.ast=u.star=u.loast=u.lowast=C(Y,"\\ast ","&lowast;"),u.therefor=u.therefore=C(Y,"\\therefore ","&there4;"),u.cuz=u.because=C(Y,"\\because ","&#8757;"),u.prop=u.propto=C(Y,"\\propto ","&prop;"),u.asymp=u.approx=C(Y,"\\approx ","&asymp;"),u.lt=C(Y,"<","&lt;"),u.gt=C(Y,">","&gt;"),u.le=u.leq=C(Y,"\\le ","&le;"),u.ge=u.geq=C(Y,"\\ge ","&ge;"),u.isin=u["in"]=C(Y,"\\in ","&isin;"),u.ni=u.contains=C(Y,"\\ni ","&ni;"),u.notni=u.niton=u.notcontains=u.doesnotcontain=C(Y,"\\not\\ni ","&#8716;"),u.sub=u.subset=C(Y,"\\subset ","&sub;"),u.sup=u.supset=u.superset=C(Y,"\\supset ","&sup;"),u.nsub=u.notsub=u.nsubset=u.notsubset=C(Y,"\\not\\subset ","&#8836;"),u.nsup=u.notsup=u.nsupset=u.notsupset=u.nsuperset=u.notsuperset=C(Y,"\\not\\supset ","&#8837;"),u.sube=u.subeq=u.subsete=u.subseteq=C(Y,"\\subseteq ","&sube;"),u.supe=u.supeq=u.supsete=u.supseteq=u.supersete=u.superseteq=C(Y,"\\supseteq ","&supe;"),u.nsube=u.nsubeq=u.notsube=u.notsubeq=u.nsubsete=u.nsubseteq=u.notsubsete=u.notsubseteq=C(Y,"\\not\\subseteq ","&#8840;"),u.nsupe=u.nsupeq=u.notsupe=u.notsupeq=u.nsupsete=u.nsupseteq=u.notsupsete=u.notsupseteq=u.nsupersete=u.nsuperseteq=u.notsupersete=u.notsuperseteq=C(Y,"\\not\\supseteq ","&#8841;");var $=g(new l,function(a,b){l.call(this,a,"<big>"+b+"</big>")});u.sum=u.summation=C($,"\\sum ","&sum;"),u.prod=u.product=C($,"\\prod ","&prod;"),u.coprod=u.coproduct=C($,"\\coprod ","&#8720;"),u.int=u.integral=u["∫"]=C($,"\\int ","&int;"),u.N=u.naturals=u.Naturals=C(W,"\\mathbb{N}","&#8469;"),u.P=u.primes=u.Primes=u.projective=u.Projective=u.probability=u.Probability=C(W,"\\mathbb{P}","&#8473;"),u.Z=u.integers=u.Integers=C(W,"\\mathbb{Z}","&#8484;"),u.Q=u.rationals=u.Rationals=C(W,"\\mathbb{Q}","&#8474;"),u.R=u.reals=u.Reals=C(W,"\\mathbb{R}","&#8477;"),u.C=u.complex=u.Complex=u.complexes=u.Complexes=u.complexplane=u.Complexplane=u.ComplexPlane=C(W,"\\mathbb{C}","&#8450;"),u.H=u.Hamiltonian=u.quaternions=u.Quaternions=C(W,"\\mathbb{H}","&#8461;"),u.quad=u.emsp=C(W,"\\quad ","    "),u.qquad=C(W,"\\qquad ","        "),u.diamond=C(W,"\\diamond ","&#9671;"),u.bigtriangleup=C(W,"\\bigtriangleup ","&#9651;"),u.ominus=C(W,"\\ominus ","&#8854;"),u.uplus=C(W,"\\uplus ","&#8846;"),u.bigtriangledown=C(W,"\\bigtriangledown ","&#9661;"),u.sqcap=C(W,"\\sqcap ","&#8851;"),u.triangleleft=C(W,"\\triangleleft ","&#8882;"),u.sqcup=C(W,"\\sqcup ","&#8852;"),u.triangleright=C(W,"\\triangleright ","&#8883;"),u.odot=C(W,"\\odot ","&#8857;"),u.bigcirc=C(W,"\\bigcirc ","&#9711;"),u.dagger=C(W,"\\dagger ","&#0134;"),u.ddagger=C(W,"\\ddagger ","&#135;"),u.wr=C(W,"\\wr ","&#8768;"),u.amalg=C(W,"\\amalg ","&#8720;"),u.models=C(W,"\\models ","&#8872;"),u.prec=C(W,"\\prec ","&#8826;"),u.succ=C(W,"\\succ ","&#8827;"),u.preceq=C(W,"\\preceq ","&#8828;"),u.succeq=C(W,"\\succeq ","&#8829;"),u.simeq=C(W,"\\simeq ","&#8771;"),u.mid=C(W,"\\mid ","&#8739;"),u.ll=C(W,"\\ll ","&#8810;"),u.gg=C(W,"\\gg ","&#8811;"),u.parallel=C(W,"\\parallel ","&#8741;"),u.bowtie=C(W,"\\bowtie ","&#8904;"),u.sqsubset=C(W,"\\sqsubset ","&#8847;"),u.sqsupset=C(W,"\\sqsupset ","&#8848;"),u.smile=C(W,"\\smile ","&#8995;"),u.sqsubseteq=C(W,"\\sqsubseteq ","&#8849;"),u.sqsupseteq=C(W,"\\sqsupseteq ","&#8850;"),u.doteq=C(W,"\\doteq ","&#8784;"),u.frown=C(W,"\\frown ","&#8994;"),u.vdash=C(W,"\\vdash ","&#8870;"),u.dashv=C(W,"\\dashv ","&#8867;"),u.longleftarrow=C(W,"\\longleftarrow ","&#8592;"),u.longrightarrow=C(W,"\\longrightarrow ","&#8594;"),u.Longleftarrow=C(W,"\\Longleftarrow ","&#8656;"),u.Longrightarrow=C(W,"\\Longrightarrow ","&#8658;"),u.longleftrightarrow=C(W,"\\longleftrightarrow ","&#8596;"),u.updownarrow=C(W,"\\updownarrow ","&#8597;"),u.Longleftrightarrow=C(W,"\\Longleftrightarrow ","&#8660;"),u.Updownarrow=C(W,"\\Updownarrow ","&#8661;"),u.mapsto=C(W,"\\mapsto ","&#8614;"),u.nearrow=C(W,"\\nearrow ","&#8599;"),u.hookleftarrow=C(W,"\\hookleftarrow ","&#8617;"),u.hookrightarrow=C(W,"\\hookrightarrow ","&#8618;"),u.searrow=C(W,"\\searrow ","&#8600;"),u.leftharpoonup=C(W,"\\leftharpoonup ","&#8636;"),u.rightharpoonup=C(W,"\\rightharpoonup ","&#8640;"),u.swarrow=C(W,"\\swarrow ","&#8601;"),u.leftharpoondown=C(W,"\\leftharpoondown ","&#8637;"),u.rightharpoondown=C(W,"\\rightharpoondown ","&#8641;"),u.nwarrow=C(W,"\\nwarrow ","&#8598;"),u.ldots=C(W,"\\ldots ","&#8230;"),u.cdots=C(W,"\\cdots ","&#8943;"),u.vdots=C(W,"\\vdots ","&#8942;"),u.ddots=C(W,"\\ddots ","&#8944;"),u.surd=C(W,"\\surd ","&#8730;"),u.triangle=C(W,"\\triangle ","&#9653;"),u.ell=C(W,"\\ell ","&#8467;"),u.top=C(W,"\\top ","&#8868;"),u.flat=C(W,"\\flat ","&#9837;"),u.natural=C(W,"\\natural ","&#9838;"),u.sharp=C(W,"\\sharp ","&#9839;"),u.wp=C(W,"\\wp ","&#8472;"),u.bot=C(W,"\\bot ","&#8869;"),u.clubsuit=C(W,"\\clubsuit ","&#9827;"),u.diamondsuit=C(W,"\\diamondsuit ","&#9826;"),u.heartsuit=C(W,"\\heartsuit ","&#9825;"),u.spadesuit=C(W,"\\spadesuit ","&#9824;"),u.oint=C(W,"\\oint ","&#8750;"),u.bigcap=C(W,"\\bigcap ","&#8745;"),u.bigcup=C(W,"\\bigcup ","&#8746;"),u.bigsqcup=C(W,"\\bigsqcup ","&#8852;"),u.bigvee=C(W,"\\bigvee ","&#8744;"),u.bigwedge=C(W,"\\bigwedge ","&#8743;"),u.bigodot=C(W,"\\bigodot ","&#8857;"),u.bigotimes=C(W,"\\bigotimes ","&#8855;"),u.bigoplus=C(W,"\\bigoplus ","&#8853;"),u.biguplus=C(W,"\\biguplus ","&#8846;"),u.lfloor=C(W,"\\lfloor ","&#8970;"),u.rfloor=C(W,"\\rfloor ","&#8971;"),u.lceil=C(W,"\\lceil ","&#8968;"),u.rceil=C(W,"\\rceil ","&#8969;"),u.slash=C(W,"\\slash ","&#47;"),u.opencurlybrace=C(W,"\\opencurlybrace ","&#123;"),u.closecurlybrace=C(W,"\\closecurlybrace ","&#125;"),u.caret=C(W,"\\caret ","^"),u.underscore=C(W,"\\underscore ","_"),u.backslash=C(W,"\\backslash ","\\"),u.vert=C(W,"|"),u.perp=u.perpendicular=C(W,"\\perp ","&perp;"),u.nabla=u.del=C(W,"\\nabla ","&nabla;"),u.hbar=C(W,"\\hbar ","&#8463;"),u.AA=u.Angstrom=u.angstrom=C(W,"\\text\\AA ","&#8491;"),u.ring=u.circ=u.circle=C(W,"\\circ ","&#8728;"),u.bull=u.bullet=C(W,"\\bullet ","&bull;"),u.setminus=u.smallsetminus=C(W,"\\setminus ","&#8726;"),u.not=u.neg=C(W,"\\neg ","&not;"),u.dots=u.ellip=u.hellip=u.ellipsis=u.hellipsis=C(W,"\\dots ","&hellip;"),u.converges=u.darr=u.dnarr=u.dnarrow=u.downarrow=C(W,"\\downarrow ","&darr;"),u.dArr=u.dnArr=u.dnArrow=u.Downarrow=C(W,"\\Downarrow ","&dArr;"),u.diverges=u.uarr=u.uparrow=C(W,"\\uparrow ","&uarr;"),u.uArr=u.Uparrow=C(W,"\\Uparrow ","&uArr;"),u.to=C(Y,"\\to ","&rarr;"),u.rarr=u.rightarrow=C(W,"\\rightarrow ","&rarr;"),u.implies=C(Y,"\\Rightarrow ","&rArr;"),u.rArr=u.Rightarrow=C(W,"\\Rightarrow ","&rArr;"),u.gets=C(Y,"\\gets ","&larr;"),u.larr=u.leftarrow=C(W,"\\leftarrow ","&larr;"),u.impliedby=C(Y,"\\Leftarrow ","&lArr;"),u.lArr=u.Leftarrow=C(W,"\\Leftarrow ","&lArr;"),u.harr=u.lrarr=u.leftrightarrow=C(W,"\\leftrightarrow ","&harr;"),u.iff=C(Y,"\\Leftrightarrow "
,"&hArr;"),u.hArr=u.lrArr=u.Leftrightarrow=C(W,"\\Leftrightarrow ","&hArr;"),u.Re=u.Real=u.real=C(W,"\\Re ","&real;"),u.Im=u.imag=u.image=u.imagin=u.imaginary=u.Imaginary=C(W,"\\Im ","&image;"),u.part=u.partial=C(W,"\\partial ","&part;"),u.inf=u.infin=u.infty=u.infinity=C(W,"\\infty ","&infin;"),u.alef=u.alefsym=u.aleph=u.alephsym=C(W,"\\aleph ","&alefsym;"),u.xist=u.xists=u.exist=u.exists=C(W,"\\exists ","&exist;"),u.and=u.land=u.wedge=C(W,"\\wedge ","&and;"),u.or=u.lor=u.vee=C(W,"\\vee ","&or;"),u.o=u.O=u.empty=u.emptyset=u.oslash=u.Oslash=u.nothing=u.varnothing=C(Y,"\\varnothing ","&empty;"),u.cup=u.union=C(W,"\\cup ","&cup;"),u.cap=u.intersect=u.intersection=C(W,"\\cap ","&cap;"),u.deg=u.degree=C(W,"^\\circ ","&deg;"),u.ang=u.angle=C(W,"\\angle ","&ang;");var _=g(new l,function(a){l.call(this,"\\"+a+" ","<span>"+a+"</span>")});c.respace=function(){this.jQ[0].className=this.next instanceof E||this.next instanceof J?"":"non-italicized-function"},u.ln=u.lg=u.log=u.span=u.proj=u.det=u.dim=u.min=u.max=u.mod=u.lcm=u.gcd=u.gcf=u.hcf=u.lim=_,function(){var a=["sin","cos","tan","sec","cosec","csc","cotan","cot"];for(var b in a)u[a[b]]=u[a[b]+"h"]=u["a"+a[b]]=u["arc"+a[b]]=u["a"+a[b]+"h"]=u["arc"+a[b]+"h"]=_}();var ba=h(function(b){this.parent=this.root=b;var c=this.jQ=this._jQ=a('<span class="cursor"></span>');this.blink=function(){c.toggleClass("blink")}});c.prev=0,c.next=0,c.parent=0,c.show=function(){this.jQ=this._jQ.removeClass("blink"),"intervalId"in this?clearInterval(this.intervalId):(this.next?this.selection&&this.selection.first.prev===this.prev?this.jQ.insertBefore(this.selection.jQ):this.jQ.insertBefore(this.next.jQ.first()):this.jQ.appendTo(this.parent.jQ),this.parent.focus()),this.intervalId=setInterval(this.blink,500);return this},c.hide=function(){"intervalId"in this&&clearInterval(this.intervalId),delete this.intervalId,this.jQ.detach(),this.jQ=a();return this},c.insertAt=function(a,b,c){var d=this.parent;this.parent=a,this.prev=b,this.next=c,d.blur()},c.insertBefore=function(a){this.insertAt(a.parent,a.prev,a),this.parent.jQ.addClass("hasCursor"),this.jQ.insertBefore(a.jQ.first());return this},c.insertAfter=function(a){this.insertAt(a.parent,a,a.next),this.parent.jQ.addClass("hasCursor"),this.jQ.insertAfter(a.jQ.last());return this},c.prependTo=function(a){this.insertAt(a,0,a.firstChild),a.textarea?this.jQ.insertAfter(a.textarea):this.jQ.prependTo(a.jQ),a.focus();return this},c.appendTo=function(a){this.insertAt(a,a.lastChild,0),this.jQ.appendTo(a.jQ),a.focus();return this},c.hopLeft=function(){this.jQ.insertBefore(this.prev.jQ.first()),this.next=this.prev,this.prev=this.prev.prev;return this},c.hopRight=function(){this.jQ.insertAfter(this.next.jQ.last()),this.prev=this.next,this.next=this.next.next;return this},c.moveLeft=function(){this.selection?this.insertBefore(this.selection.first).clearSelection():this.prev?this.prev.lastChild?this.appendTo(this.prev.lastChild):this.hopLeft():this.parent.prev?this.appendTo(this.parent.prev):this.parent!==this.root&&this.insertBefore(this.parent.parent);return this.show()},c.moveRight=function(){this.selection?this.insertAfter(this.selection.last).clearSelection():this.next?this.next.firstChild?this.prependTo(this.next.firstChild):this.hopRight():this.parent.next?this.prependTo(this.parent.next):this.parent!==this.root&&this.insertAfter(this.parent.parent);return this.show()},c.seek=function(a,b,c){var e=this.clearSelection();if(a.hasClass("empty")){e.prependTo(a.data(d).block);return e}var f=a.data(d);if(f){if(f.cmd&&!f.block){a.outerWidth()>2*(b-a.offset().left)?e.insertBefore(f.cmd):e.insertAfter(f.cmd);return e}}else a=a.parent(),f=a.data(d),f||(f={block:e.root});f.cmd?e.insertAfter(f.cmd):e.appendTo(f.block);var g=e.jQ.offset().left-b,h;do e.moveLeft(),h=g,g=e.jQ.offset().left-b;while(g>0&&(e.prev||e.parent!==e.root));-g>h&&e.moveRight();return e},c.writeLatex=function(a){this.deleteSelection(),a=a&&a.match(/\\text\{([^}]|\\\})*\}|\\[a-z]*|[^\s]/ig)||0,function b(c){while(a.length){var d=a.shift();if(!d||d==="}")return;var e;if(d.slice(0,6)==="\\text{"){e=new O(d.slice(6,-1)),c.insertNew(e).insertAfter(e);continue}if(d==="\\left"||d==="\\right"){d=a.shift(),d==="\\"&&(d=a.shift()),c.insertCh(d),e=c.prev||c.parent.parent;if(c.prev)return;a.unshift("{")}else if(/^\\[a-z]+$/i.test(d)){d=d.slice(1);var e=u[d];if(e)c.insertNew(e=new e(d));else{e=new O(d),c.insertNew(e).insertAfter(e);continue}}else d.match(/[a-eg-zA-Z]/)?e=new V(d):(e=u[d])?e=new e(d):e=new W(d),c.insertNew(e);e.eachChild(function(d){c.appendTo(d);var e=a.shift();if(!e)return!1;e==="{"?b(c):c.insertCh(e)}),c.insertAfter(e)}}(this);return this.hide()},c.write=function(a){return this.show().insertCh(a)},c.insertCh=function(a){var b;a.match(/^[a-eg-zA-Z]$/)?b=new V(a):(b=t[a]||u[a])?b=new b(a):b=new W(a),this.selection&&(this.prev=this.selection.first.prev,this.next=this.selection.last.next,b.replaces(this.selection),delete this.selection);return this.insertNew(b)},c.insertNew=function(a){a.createBefore(this);return this},c.unwrapGramp=function(){var a=this.parent.parent,b=a.parent,c=a.prev,d=this;a.eachChild(function(d){d.isEmpty()||(d.eachChild(function(c){c.parent=b,c.jQ.insertBefore(a.jQ.first())}),d.firstChild.prev=c,c?c.next=d.firstChild:b.firstChild=d.firstChild,c=d.lastChild)}),c.next=a.next,a.next?a.next.prev=c:b.lastChild=c;if(!this.next)if(this.prev)this.next=this.prev.next;else while(!this.next){this.parent=this.parent.next;if(this.parent)this.next=this.parent.firstChild;else{this.next=a.next,this.parent=b;break}}this.next?this.insertBefore(this.next):this.appendTo(b),a.jQ.remove(),a.prev&&a.prev.respace(),a.next&&a.next.respace()},c.backspace=function(){if(!this.deleteSelection())if(this.prev)this.prev.isEmpty()?this.prev=this.prev.remove().prev:this.selectLeft();else if(this.parent!==this.root){if(this.parent.parent.isEmpty())return this.insertAfter(this.parent.parent).backspace();this.unwrapGramp()}this.prev&&this.prev.respace(),this.next&&this.next.respace(),this.parent.bubble("redraw");return this},c.deleteForward=function(){if(!this.deleteSelection())if(this.next)this.next.isEmpty()?this.next=this.next.remove().next:this.selectRight();else if(this.parent!==this.root){if(this.parent.parent.isEmpty())return this.insertBefore(this.parent.parent).deleteForward();this.unwrapGramp()}this.prev&&this.prev.respace(),this.next&&this.next.respace(),this.parent.bubble("redraw");return this},c.selectFrom=function(a){var b=this,c=a;loopThroughAncestors:for(;;){for(var d=this;d!==b.parent.parent;d=d.parent.parent)if(d.parent===c.parent){f=d,g=c;break loopThroughAncestors}for(var e=a;e!==c.parent.parent;e=e.parent.parent)if(b.parent===e.parent){f=b,g=e;break loopThroughAncestors}b.parent.parent&&(b=b.parent.parent),c.parent.parent&&(c=c.parent.parent)}var f,g,h;if(f.next!==g){for(var i=f;i;i=i.next)if(i===g.prev){h=!0;break}h||(h=g,g=f,f=h)}this.hide().selection=new bb(f.prev.next||f.parent.firstChild,g.next.prev||g.parent.lastChild),this.insertAfter(g.next.prev||g.parent.lastChild),this.root.selectionChanged()},c.selectLeft=function(){if(this.selection)if(this.selection.first===this.next)this.prev?this.hopLeft().selection.extendLeft():this.parent!==this.root&&this.insertBefore(this.parent.parent).selection.levelUp();else{this.hopLeft();if(this.selection.first===this.selection.last){this.clearSelection();return}this.selection.retractLeft()}else{if(this.prev)this.hopLeft();else if(this.parent!==this.root)this.insertBefore(this.parent.parent);else return;this.hide().selection=new bb(this.next)}this.root.selectionChanged()},c.selectRight=function(){if(this.selection)if(this.selection.last===this.prev)this.next?this.hopRight().selection.extendRight():this.parent!==this.root&&this.insertAfter(this.parent.parent).selection.levelUp();else{this.hopRight();if(this.selection.first===this.selection.last){this.clearSelection();return}this.selection.retractRight()}else{if(this.next)this.hopRight();else if(this.parent!==this.root)this.insertAfter(this.parent.parent);else return;this.hide().selection=new bb(this.prev)}this.root.selectionChanged()},c.clearSelection=function(){this.show().selection&&(this.selection.clear(),delete this.selection,this.root.selectionChanged());return this},c.deleteSelection=function(){if(!this.show().selection)return!1;this.prev=this.selection.first.prev,this.next=this.selection.last.next,this.selection.remove(),this.root.selectionChanged();return delete this.selection};var bb=i(n);c.jQinit=function(a){this.jQ=a.wrapAll('<span class="selection"></span>').parent()},c.blockify=function(){this.jQ.replaceWith(this.jQ=this.jQ.children());return n.prototype.blockify.call(this)},c.clear=function(){this.jQ.replaceWith(this.jQ.children());return this},c.levelUp=function(){var a=this,b=a.first=a.last=a.last.parent.parent;a.clear().jQinit(b.jQ);return a},c.extendLeft=function(){this.first=this.first.prev,this.first.jQ.prependTo(this.jQ)},c.extendRight=function(){this.last=this.last.next,this.last.jQ.appendTo(this.jQ)},c.retractRight=function(){this.first.jQ.insertBefore(this.jQ),this.first=this.first.next},c.retractLeft=function(){this.last.jQ.insertAfter(this.jQ),this.last=this.last.prev},a.fn.mathquill=function(b,c){switch(b){case"redraw":this.find(":not(:has(:first))").each(function(){var b=a(this).data(d),c=b&&(b.block||b.cmd);c&&c.bubble("redraw")});return this;case"revert":return this.each(function(){var b=a(this).data(d);b&&b.revert&&b.revert()});case"latex":if(arguments.length>1)return this.each(function(){var b=a(this).data(d);b&&b.block&&b.block.renderLatex&&b.block.renderLatex(c)});var e=this.data(d);return e&&e.block&&e.block.latex();case"text":var e=this.data(d);return e&&e.block&&e.block.text();case"html":return this.html().replace(/ ?hasCursor|hasCursor /,"").replace(/ class=(""|(?= |>))/g,"").replace(/<span class="?cursor( blink)?"?><\/span>/i,"").replace(/<span class="?textarea"?><textarea><\/textarea><\/span>/i,"");case"write":if(arguments.length>1)return this.each(function(){var b=a(this).data(d),e=b&&b.block,f=e&&e.cursor;f&&(f.writeLatex(c),e.blur())});default:var f=b==="textbox",g=f||b==="editable",h=f?s:q;return this.each(function(){p(a(this),new h,f,g)})}},a(function(){a(".mathquill-editable:not(.mathquill-rendered-math)").mathquill("editable"),a(".mathquill-textbox:not(.mathquill-rendered-math)").mathquill("textbox"),a(".mathquill-embedded-latex").mathquill()})})()